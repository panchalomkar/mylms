{"version":3,"file":"postmessage.min.js","sources":["../src/postmessage.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Closes the collabora window.\n *\n * @module     mod_collabora/monitorclose\n * @author     Andreas Grabs <moodle@grabs-edv.de>\n * @copyright  2019 Humboldt-Universit√§t zu Berlin <moodle-support@cms.hu-berlin.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport fragment from 'core/fragment';\nimport templates from 'core/templates';\nimport ajax from 'core/ajax';\nimport notification from 'core/notification';\nimport log from 'core/log';\n\nclass PostMessageHandler {\n    asPopup;\n    collaboraUrl;\n    component;\n    contextid;\n    courseURL;\n    id;\n    iframeid;\n    imgBackUrl;\n    isSaving;\n    newVersion;\n    originCollabora;\n    originMoodle;\n    strBack;\n    uiMode;\n    version;\n    useVersions;\n    versionManager;\n    versionViewer;\n    spinner;\n\n    constructor(opts) {\n        this.courseURL = opts.courseurl;\n        this.collaboraUrl = opts.collaboraurl;\n        if ('component' in opts) {\n            this.component = opts.component;\n        } else {\n            this.component = 'mod_collabora';\n        }\n        this.originCollabora = opts.origincollabora;\n        this.originMoodle = opts.originmoodle;\n        this.asPopup = opts.aspopup;\n        this.iframeid = opts.iframeid;\n        this.id = opts.id;\n        this.contextid = opts.contextid;\n        this.strBack = opts.strback;\n        this.imgBackUrl = opts.imgbackurl;\n        this.uiMode = opts.uimode;\n        if (opts.useversions == undefined) {\n            this.useVersions = false;\n        } else {\n            this.useVersions = opts.useversions;\n        }\n        this.versionManager = opts.versionmanager;\n        this.isSaving = false;\n\n        // The version is \"0\" by default.\n        this.version = 0;\n        this.newVersion = 0;\n\n        this.versionViewer = document.querySelector('#' + opts.versionviewerid);\n        this.spinner = document.querySelector('#collabora-spinner-' + this.id);\n    }\n\n    init() {\n        const _this = this;\n\n        _this.setFrameData();\n        _this.initModal();\n        window.addEventListener('message', function(e) {\n            _this.receiveMessage(e);\n        });\n    }\n\n    /**\n     * Listener for the event 'message'\n     * @param {Event} event\n     */\n    receiveMessage(event) {\n        var msg, msgId;\n        const _this = this;\n\n        log.debug('ReceiveMessage from ' + event.origin + ': ' + event.data);\n        // We only handle messages from Moodle or Collabora!\n        if (event.origin != _this.originCollabora && event.origin != _this.originMoodle) {\n            log.debug('!!!!Received Message from wrong origin \"' + event.origin + '\"');\n            return;\n        }\n        if (typeof event.data !== 'string' && !(event.data instanceof String)) {\n            return;\n        }\n\n        msg = JSON.parse(event.data);\n        if (!msg) {\n            return;\n        }\n\n        msgId = msg.MessageId;\n\n        switch (msgId) {\n            // Messages sent by collabora editor.\n            case 'UI_Close':\n                _this.closeDocument();\n                break;\n            case 'App_LoadingStatus':\n                _this.tellPostmessageReady(msg);\n                break;\n            case 'UI_FileVersions':\n                _this.showVersionView();\n                break;\n            case 'UI_Save':\n                _this.invokeSave();\n                break;\n            case 'Doc_ModifiedStatus':\n                _this.checkSaved(msg);\n                break;\n            case 'Clicked_Button':\n                _this.handleCustomButton(msg);\n                break;\n            case 'App_VersionRestore':\n                _this.restoreVersion(msg);\n                break;\n\n            // Messages sent by version viewer.\n            case 'SET_VERSION':\n                _this.version = msg.Values.version;\n                _this.setFrameData();\n                _this.showVersionView();\n                break;\n            case 'RESTORE_VERSION':\n                _this.prepareRestoreVersion(msg.Values.version);\n                break;\n            case 'DELETE_VERSION':\n                _this.deleteVersion(msg.Values.version);\n                break;\n        }\n    }\n\n    /**\n     * Close the document or go back to the course page, depending on the current view.\n     */\n    closeDocument() {\n        const _this = this;\n\n        if (_this.asPopup) {\n            window.close();\n        } else {\n            window.location.href = _this.courseURL;\n        }\n    }\n\n    /**\n     * Show or hide an overlay spinner.\n     *\n     * @param {boolean} show\n     */\n    showSpinner(show) {\n        const _this = this;\n\n        var iframe = document.querySelector('#' + _this.iframeid);\n        if (show) {\n            _this.spinner.classList.remove('d-none');\n            iframe.style.opacity = 0.1;\n\n        } else {\n            _this.spinner.classList.add('d-none');\n            iframe.style.opacity = 1;\n        }\n    }\n\n    /**\n     * Show the version_view page with all current versions.\n     */\n    showVersionView() {\n        if (!this.useVersions) {\n            return;\n        }\n        const _this = this;\n        _this.loadVersionView();\n        $('#' + _this.versionViewer.id).collapse('show');\n    }\n\n    /**\n     * Load the content for the version viewer.\n     */\n    loadVersionView() {\n        const _this = this;\n\n        if (!_this.versionManager) {\n            return;\n        }\n\n        const serviceparams = {\n            'function': 'version_viewer_content',\n            'id': _this.id,\n            'version': _this.version\n        };\n\n        fragment.loadFragment(_this.component, 'get_html', _this.contextid, serviceparams).then(\n            function(html, js) {\n                let contentcontainer = document.querySelector('#' + _this.versionViewer.id + ' .card-body');\n                contentcontainer.innerHTML = html;\n                if (js) {\n                    templates.runTemplateJS(js);\n                }\n                return;\n            }\n        ).fail(notification.exception);\n    }\n\n    /**\n     * Invoke the save command.\n     * This is different to the default save action because we can prevent saving of unmodified documents\n     * which prevents creating new versions of the same document.\n     */\n    invokeSave() {\n        const _this = this;\n\n        _this.isSaving = true;\n\n        const postObject = {\n            'MessageId': 'Action_Save',\n            'Values': {\n                'DontTerminateEdit': true,\n                'DontSaveIfUnmodified': true\n            }\n        };\n        _this.postMessage(postObject);\n    }\n\n    /**\n     * Check saving has finished and reload version view if open.\n     * @param {object} msg The received message object from the collabora editor.\n     */\n    checkSaved(msg) {\n        const _this = this;\n\n        _this.isSaving = true;\n\n        if (msg.Values.Modified == false) {\n            if (_this.isSaving) {\n                if (!_this.useVersions) {\n                    return;\n                }\n                _this.loadVersionView();\n            }\n        }\n    }\n\n    /**\n     * Post the first message to collabora when the document is ready.\n     * @param {object} msg The received message object from the collabora editor.\n     */\n    tellPostmessageReady(msg) {\n        const _this = this;\n\n        if (msg.Values) {\n            if (msg.Values.Status == 'Document_Loaded') {\n                var postObject;\n                // Send the Host_PostMessageReady  before other posts (Mandatory)\n                postObject = {\n                    'MessageId': 'Host_PostmessageReady'\n                };\n                _this.postMessage(postObject);\n\n                // If newVersion is set, we have to tell the editor we want to restore to it.\n                if (_this.newVersion != 0) {\n                    postObject = {\n                        'MessageId': 'Host_VersionRestore',\n                        'Values': {\n                        'Status': 'Pre_Restore'\n                        }\n                    };\n                    _this.postMessage(postObject);\n                    return;\n                }\n\n                // Disable the default save command to activate our own.\n                postObject = {\n                    'MessageId': 'Disable_Default_UIAction',\n                    'Values': {\n                        'action': 'UI_Save',\n                        'disable': true\n                    }\n                };\n                _this.postMessage(postObject);\n\n                // Set the ui mode (notebook or classic).\n                if (_this.uiMode != 0) {\n                    postObject = {\n                        'MessageId': 'Action_ChangeUIMode',\n                        'Values': {\n                            'Mode': _this.uiMode\n                        }\n                    };\n                    _this.postMessage(postObject);\n                }\n                // _this.spinner.classList.add('d-none');\n                _this.showSpinner(false);\n                if (_this.version > 0) {\n                    _this.addBackButton();\n                }\n            }\n        }\n    }\n\n    handleCustomButton(msg) {\n        const _this = this;\n\n        if (msg.Values) {\n            if (msg.Values.Id == 'moodle_go_back') {\n                _this.version = 0;\n                _this.setFrameData();\n            }\n        }\n\n    }\n\n    addBackButton() {\n        const _this = this;\n\n        var postObject = {\n            'MessageId': 'Insert_Button',\n            'Values': {\n                'id': 'moodle_go_back',\n                'imgurl': _this.imgBackUrl,\n                'label': _this.strBack,\n                'hint': _this.strBack\n            }\n        };\n        _this.postMessage(postObject);\n    }\n\n    /**\n     * Send a message to the collabora editor\n     * @param {object} postObject The object we want to post.\n     */\n    postMessage(postObject) {\n        const _this = this;\n\n        postObject.SendTime = Date.now();\n        var message = JSON.stringify(postObject);\n        log.debug('Post message to collabora: ' + message);\n\n        var iframe = document.querySelector('#' + _this.iframeid);\n        if (iframe === null || iframe == undefined) {\n            log.debug('The iframe \"' + _this.iframeid + '\" has vanished');\n            return;\n        }\n        iframe = iframe.contentWindow || (iframe.contentDocument.document || iframe.contentDocument);\n\n        iframe.postMessage(message, _this.originCollabora);\n    }\n\n    /**\n     * Prepare the modal feature to set the frameData while showing or hiding the modal.\n     */\n    initModal() {\n        const _this = this;\n\n        // Get the elements between which the iframe is moved back and forth.\n        const inlineelement = document.querySelector('#collabora-inline_' + _this.id);\n        const modalelement = document.querySelector('#collaboramodal-body_' + _this.id);\n        // Get the iframe container we move to one of the above defined elements.\n        const iframecontainer = document.querySelector('#iframe-container_' + _this.id);\n\n        // Move the iframe to the modal element.\n        $(\"#collaboramodal_\" + _this.id).on(\"show.bs.modal\", function() {\n            modalelement.append(iframecontainer);\n            $(\"body\").addClass(\"modal-open\");\n\n            _this.setFrameData();\n        });\n\n        // Move the iframe to the inline element.\n        $(\"#collaboramodal_\" + _this.id).on(\"hide.bs.modal\", function() {\n            inlineelement.append(iframecontainer);\n            $(\"body\").removeClass(\"modal-open\");\n            _this.setFrameData();\n        });\n\n    }\n\n    /**\n     * Set the Frame content by posting a temporary form to the iframe.\n     */\n    setFrameData() {\n        const _this = this;\n\n        log.debug('Set iframe source: ' + _this.collaboraUrl);\n\n        // Check whether there is an iframe we can post the form to.\n        var iframe = document.querySelector('#' + _this.iframeid);\n        if (iframe === null || iframe == undefined) {\n            log.debug('The iframe \"' + _this.iframeid + '\" has vanished');\n            return;\n        }\n\n        // Load the wopi_src params.\n        var serviceparams = {\n            'function': 'wopi_src',\n            'id': _this.id,\n            'version': _this.version\n        };\n        fragment.loadFragment(_this.component, 'get_html', _this.contextid, serviceparams).then(\n            function(strparams) {\n                var params = JSON.parse(strparams);\n\n                var form = document.createElement(\"form\");\n                form.method = \"get\";\n                form.action = _this.collaboraUrl;\n                form.target = _this.iframeid;\n                for (const [key, value] of Object.entries(params)) {\n                    var element = document.createElement(\"input\");\n                    element.type = \"hidden\";\n                    element.name = key;\n                    element.value = value;\n                    form.appendChild(element);\n                    log.debug('Add element ' + key + ': ' + value);\n                }\n                document.body.appendChild(form);\n\n                form.submit();\n                return;\n            }\n        ).fail(notification.exception);\n\n        return;\n    }\n\n    prepareRestoreVersion(version) {\n        const _this = this;\n\n        // _this.spinner.classList.remove('d-none');\n        _this.showSpinner(true);\n\n        _this.version = 0; // Set version to the current document, so we can tell other users using this document.\n        _this.newVersion = version;\n        _this.setFrameData();\n    }\n\n    restoreVersion(msg) {\n        const _this = this;\n\n        if (!_this.versionManager) {\n            _this.showSpinner(true);\n            return;\n        }\n        if (msg.Values.Status == 'Pre_Restore_Ack') {\n            // Now we call the webservice with \"ajax.call\" and get an array of promises.\n            // Because we call only one service we only get one promise inside this array.\n            var myPromises = ajax.call([{ // Note: there is a Square bracket!\n                // The parameter methodname is the webservice we want to call.\n                methodname: _this.component + '_restore_version',\n                // The second one is a json object with all in the webservice defined parameters.\n                // The submitaction is needed to set the right action url in the mform.\n                args: {id: _this.id, version: _this.newVersion}\n            }]);\n\n            // We only have one promise because we call only one webservice. More would be possible.\n            // So we just use promises[0].\n            myPromises[0].done(function(data) {\n                if (data.success == 1) {\n                    _this.version = 0;\n                    _this.newVersion = 0;\n                    _this.setFrameData();\n\n                    _this.showVersionView();\n\n                } else {\n                    notification.exception({message: data.failuremsg});\n                }\n            }).fail(notification.exception); // If any went wrong we let the user know.\n        }\n    }\n\n    deleteVersion(version) {\n        const _this = this;\n\n        if (!_this.versionManager) {\n            return;\n        }\n\n        // Now we call the webservice with \"ajax.call\" and get an array of promises.\n        // Because we call only one service we only get one promise inside this array.\n        var myPromises = ajax.call([{ // Note: there is a Square bracket!\n            // The parameter methodname is the webservice we want to call.\n            methodname: _this.component + '_delete_version',\n            // The second one is a json object with all in the webservice defined parameters.\n            // The submitaction is needed to set the right action url in the mform.\n            args: {id: _this.id, version: version}\n        }]);\n\n        // We only have one promise because we call only one webservice. More would be possible.\n        // So we just use promises[0].\n        myPromises[0].done(function(data) {\n            if (data.success == 1) {\n                if (version == _this.version) {\n                    _this.version = 0; // If the deleted version is in the editor, we set it to the default version.\n                    _this.setFrameData();\n                }\n                _this.showVersionView();\n            } else {\n                notification.exception({message: data.failuremsg});\n            }\n        }).fail(notification.exception); // If any went wrong we let the user know.\n    }\n}\n\nexport const init = (opts) => {\n    const pm = new PostMessageHandler(opts);\n    pm.init();\n};\n"],"names":["PostMessageHandler","constructor","opts","courseURL","courseurl","collaboraUrl","collaboraurl","component","originCollabora","origincollabora","originMoodle","originmoodle","asPopup","aspopup","iframeid","id","contextid","strBack","strback","imgBackUrl","imgbackurl","uiMode","uimode","undefined","useversions","useVersions","versionManager","versionmanager","isSaving","version","newVersion","versionViewer","document","querySelector","versionviewerid","spinner","this","init","_this","setFrameData","initModal","window","addEventListener","e","receiveMessage","event","msg","debug","origin","data","String","JSON","parse","MessageId","closeDocument","tellPostmessageReady","showVersionView","invokeSave","checkSaved","handleCustomButton","restoreVersion","Values","prepareRestoreVersion","deleteVersion","close","location","href","showSpinner","show","iframe","classList","remove","style","opacity","add","loadVersionView","collapse","serviceparams","loadFragment","then","html","js","innerHTML","runTemplateJS","fail","notification","exception","postMessage","Modified","Status","postObject","addBackButton","Id","SendTime","Date","now","message","stringify","contentWindow","contentDocument","inlineelement","modalelement","iframecontainer","on","append","addClass","removeClass","strparams","params","form","createElement","method","action","target","key","value","Object","entries","element","type","name","appendChild","body","submit","ajax","call","methodname","args","done","success","failuremsg"],"mappings":"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"}