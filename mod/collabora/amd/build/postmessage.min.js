define("mod_collabora/postmessage",["exports","jquery","core/fragment","core/templates","core/ajax","core/notification","core/log"],(function(_exports,_jquery,_fragment,_templates,_ajax,_notification,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);class PostMessageHandler{constructor(opts){_defineProperty(this,"asPopup",void 0),_defineProperty(this,"collaboraUrl",void 0),_defineProperty(this,"component",void 0),_defineProperty(this,"contextid",void 0),_defineProperty(this,"courseURL",void 0),_defineProperty(this,"id",void 0),_defineProperty(this,"iframeid",void 0),_defineProperty(this,"imgBackUrl",void 0),_defineProperty(this,"isSaving",void 0),_defineProperty(this,"newVersion",void 0),_defineProperty(this,"originCollabora",void 0),_defineProperty(this,"originMoodle",void 0),_defineProperty(this,"strBack",void 0),_defineProperty(this,"uiMode",void 0),_defineProperty(this,"version",void 0),_defineProperty(this,"useVersions",void 0),_defineProperty(this,"versionManager",void 0),_defineProperty(this,"versionViewer",void 0),_defineProperty(this,"spinner",void 0),this.courseURL=opts.courseurl,this.collaboraUrl=opts.collaboraurl,this.component="component"in opts?opts.component:"mod_collabora",this.originCollabora=opts.origincollabora,this.originMoodle=opts.originmoodle,this.asPopup=opts.aspopup,this.iframeid=opts.iframeid,this.id=opts.id,this.contextid=opts.contextid,this.strBack=opts.strback,this.imgBackUrl=opts.imgbackurl,this.uiMode=opts.uimode,null==opts.useversions?this.useVersions=!1:this.useVersions=opts.useversions,this.versionManager=opts.versionmanager,this.isSaving=!1,this.version=0,this.newVersion=0,this.versionViewer=document.querySelector("#"+opts.versionviewerid),this.spinner=document.querySelector("#collabora-spinner-"+this.id)}init(){const _this=this;_this.setFrameData(),_this.initModal(),window.addEventListener("message",(function(e){_this.receiveMessage(e)}))}receiveMessage(event){var msg;const _this=this;if(_log.default.debug("ReceiveMessage from "+event.origin+": "+event.data),event.origin==_this.originCollabora||event.origin==_this.originMoodle){if(("string"==typeof event.data||event.data instanceof String)&&(msg=JSON.parse(event.data)))switch(msg.MessageId){case"UI_Close":_this.closeDocument();break;case"App_LoadingStatus":_this.tellPostmessageReady(msg);break;case"UI_FileVersions":_this.showVersionView();break;case"UI_Save":_this.invokeSave();break;case"Doc_ModifiedStatus":_this.checkSaved(msg);break;case"Clicked_Button":_this.handleCustomButton(msg);break;case"App_VersionRestore":_this.restoreVersion(msg);break;case"SET_VERSION":_this.version=msg.Values.version,_this.setFrameData(),_this.showVersionView();break;case"RESTORE_VERSION":_this.prepareRestoreVersion(msg.Values.version);break;case"DELETE_VERSION":_this.deleteVersion(msg.Values.version)}}else _log.default.debug('!!!!Received Message from wrong origin "'+event.origin+'"')}closeDocument(){const _this=this;_this.asPopup?window.close():window.location.href=_this.courseURL}showSpinner(show){const _this=this;var iframe=document.querySelector("#"+_this.iframeid);show?(_this.spinner.classList.remove("d-none"),iframe.style.opacity=.1):(_this.spinner.classList.add("d-none"),iframe.style.opacity=1)}showVersionView(){if(!this.useVersions)return;this.loadVersionView(),(0,_jquery.default)("#"+this.versionViewer.id).collapse("show")}loadVersionView(){const _this=this;if(!_this.versionManager)return;const serviceparams={function:"version_viewer_content",id:_this.id,version:_this.version};_fragment.default.loadFragment(_this.component,"get_html",_this.contextid,serviceparams).then((function(html,js){document.querySelector("#"+_this.versionViewer.id+" .card-body").innerHTML=html,js&&_templates.default.runTemplateJS(js)})).fail(_notification.default.exception)}invokeSave(){this.isSaving=!0;this.postMessage({MessageId:"Action_Save",Values:{DontTerminateEdit:!0,DontSaveIfUnmodified:!0}})}checkSaved(msg){const _this=this;if(_this.isSaving=!0,0==msg.Values.Modified&&_this.isSaving){if(!_this.useVersions)return;_this.loadVersionView()}}tellPostmessageReady(msg){const _this=this;if(msg.Values&&"Document_Loaded"==msg.Values.Status){var postObject;if(postObject={MessageId:"Host_PostmessageReady"},_this.postMessage(postObject),0!=_this.newVersion)return postObject={MessageId:"Host_VersionRestore",Values:{Status:"Pre_Restore"}},void _this.postMessage(postObject);postObject={MessageId:"Disable_Default_UIAction",Values:{action:"UI_Save",disable:!0}},_this.postMessage(postObject),0!=_this.uiMode&&(postObject={MessageId:"Action_ChangeUIMode",Values:{Mode:_this.uiMode}},_this.postMessage(postObject)),_this.showSpinner(!1),_this.version>0&&_this.addBackButton()}}handleCustomButton(msg){const _this=this;msg.Values&&"moodle_go_back"==msg.Values.Id&&(_this.version=0,_this.setFrameData())}addBackButton(){var postObject={MessageId:"Insert_Button",Values:{id:"moodle_go_back",imgurl:this.imgBackUrl,label:this.strBack,hint:this.strBack}};this.postMessage(postObject)}postMessage(postObject){const _this=this;postObject.SendTime=Date.now();var message=JSON.stringify(postObject);_log.default.debug("Post message to collabora: "+message);var iframe=document.querySelector("#"+_this.iframeid);null!==iframe&&null!=iframe?(iframe=iframe.contentWindow||iframe.contentDocument.document||iframe.contentDocument).postMessage(message,_this.originCollabora):_log.default.debug('The iframe "'+_this.iframeid+'" has vanished')}initModal(){const _this=this,inlineelement=document.querySelector("#collabora-inline_"+_this.id),modalelement=document.querySelector("#collaboramodal-body_"+_this.id),iframecontainer=document.querySelector("#iframe-container_"+_this.id);(0,_jquery.default)("#collaboramodal_"+_this.id).on("show.bs.modal",(function(){modalelement.append(iframecontainer),(0,_jquery.default)("body").addClass("modal-open"),_this.setFrameData()})),(0,_jquery.default)("#collaboramodal_"+_this.id).on("hide.bs.modal",(function(){inlineelement.append(iframecontainer),(0,_jquery.default)("body").removeClass("modal-open"),_this.setFrameData()}))}setFrameData(){const _this=this;_log.default.debug("Set iframe source: "+_this.collaboraUrl);var iframe=document.querySelector("#"+_this.iframeid);if(null!==iframe&&null!=iframe){var serviceparams={function:"wopi_src",id:_this.id,version:_this.version};_fragment.default.loadFragment(_this.component,"get_html",_this.contextid,serviceparams).then((function(strparams){var params=JSON.parse(strparams),form=document.createElement("form");form.method="get",form.action=_this.collaboraUrl,form.target=_this.iframeid;for(const[key,value]of Object.entries(params)){var element=document.createElement("input");element.type="hidden",element.name=key,element.value=value,form.appendChild(element),_log.default.debug("Add element "+key+": "+value)}document.body.appendChild(form),form.submit()})).fail(_notification.default.exception)}else _log.default.debug('The iframe "'+_this.iframeid+'" has vanished')}prepareRestoreVersion(version){this.showSpinner(!0),this.version=0,this.newVersion=version,this.setFrameData()}restoreVersion(msg){const _this=this;_this.versionManager?"Pre_Restore_Ack"==msg.Values.Status&&_ajax.default.call([{methodname:_this.component+"_restore_version",args:{id:_this.id,version:_this.newVersion}}])[0].done((function(data){1==data.success?(_this.version=0,_this.newVersion=0,_this.setFrameData(),_this.showVersionView()):_notification.default.exception({message:data.failuremsg})})).fail(_notification.default.exception):_this.showSpinner(!0)}deleteVersion(version){const _this=this;_this.versionManager&&_ajax.default.call([{methodname:_this.component+"_delete_version",args:{id:_this.id,version:version}}])[0].done((function(data){1==data.success?(version==_this.version&&(_this.version=0,_this.setFrameData()),_this.showVersionView()):_notification.default.exception({message:data.failuremsg})})).fail(_notification.default.exception)}}_exports.init=opts=>{new PostMessageHandler(opts).init()}}));

//# sourceMappingURL=postmessage.min.js.map