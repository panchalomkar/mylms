/**
 * Main js for template importer
 *
 * @module     local/edwisersiteimporter
 * @author     Yogesh Shirsath
 * @copyright  (c) 2020 WisdmLabs (https://wisdmlabs.com/) <support@wisdmlabs.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_edwiserpagebuilder/pageslistsettings",["jquery","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax","core/str","core/toast"],(function($,ModalFactory,ModalEvents,Templates,Notification,Ajax,Str,Toast){const SELECTORS_PAGE_SUB_HEADER=".page_sub_header",SELECTORS_TAG_BOX=".tag-box",SELECTORS_PAGE_SUB_HEADER_MENUS=".page_sub_header-menus",SELECTORS_TABLE_ROW=".epb_table_row",SELECTORS_ROW_NAME=".epb_table_row-name",SELECTORS_ROW_INPUT=".pagename_edit_form input[name=pagename]",SELECTORS_ROW_OLDINPUT=".pagename_edit_form input[name=old_pagename]",SELECTORS_ROW_PAGENAME=".epb_table_row-name .pagename",SELECTORS_MODIFIE_DDATE=".epb_table_row-date",SELECTORS_TARGET_COPYURL=".target_url",SELECTORS_ADD_PAGE_ROW="#epb_add_page_row",SELECTORS_BTN_EDIT=".btn-edit",SELECTORS_BTN_SUBMITEDIT=".btn-submitedit",SELECTORS_BTN_COPYURL=".btn-copyurl",SELECTORS_BTN_DUPLICATE=".btn-duplicate",SELECTORS_BTN_DELETE=".btn-delete",SELECTORS_BTN_ADDPAGE=".btn-addpage",SELECTORS_BTN_EYE=".btn-eye",SELECTORS_BTN_EYECLOSE=".btn-eyeclose",SELECTORS_BTN_PUBLISH=".btn-publish",SELECTORS_HIDDEN_TAG=".hidden-tag",ACTION_UPDATE_PAGE="update_page",ACTION_DUPLICATE_PAGE="replicate_page_with_layouts",ACTION_DELETE_PAGE_RECORD="delete_page",ACTION_ADD_NEW_PAGE="add_new_page",ACTION_PUBLISH_PAGE="publish_page_with_layouts",strings=[{key:"copyurl_toast_msg",component:"local_edwiserpagebuilder"},{key:"replicate_toast_msg",component:"local_edwiserpagebuilder"},{key:"delete_toast_msg",component:"local_edwiserpagebuilder"},{key:"published",component:"local_edwiserpagebuilder"},{key:"update_text",component:"local_edwiserpagebuilder"},{key:"no",component:"local_edwiserpagebuilder"},{key:"yes",component:"local_edwiserpagebuilder"},{key:"hidden_text",component:"local_edwiserpagebuilder"},{key:"show_toast_msg",component:"local_edwiserpagebuilder"},{key:"pagepublishmodalhead",component:"local_edwiserpagebuilder"},{key:"pagepublishmodaldesc",component:"local_edwiserpagebuilder"},{key:"pageupdatemodalhead",component:"local_edwiserpagebuilder"},{key:"pageupdatemodaldesc",component:"local_edwiserpagebuilder"},{key:"updatemsg",component:"local_edwiserpagebuilder"}];var LANGS;function dateModifier(modifiedDate){let date=new Date(1e3*modifiedDate);return date.getDate()+" "+["January","February","March","April","May","June","July","August","September","October","November","December"][date.getMonth()]+" "+date.getFullYear()}function showToastMessage(classes,message){Toast.add(message,{delay:3e3,closeButton:!0,type:" epb-cp-toast epb-toast-message "+classes})}function showEditPagename(e){let pageid=$(this).data("value"),tableRowName=$("#".concat(pageid," ").concat(SELECTORS_ROW_NAME)),inputField=$("#".concat(pageid," ").concat(SELECTORS_ROW_INPUT)),pageNameLinkText=$("#".concat(pageid," ").concat(SELECTORS_ROW_PAGENAME));$(SELECTORS_ROW_NAME).removeClass("name_editing"),tableRowName.addClass("name_editing"),inputField.focus(),inputField.val(""),inputField.val(pageNameLinkText.text());let inputElement=inputField.get(0);inputElement.scrollLeft=inputElement.scrollWidth}function submitUpdatedPagename(e){let id=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e.preventDefault();let pageid=id||$(this).closest(".input-group").data("value"),inputField=$("#".concat(pageid," ").concat(SELECTORS_ROW_INPUT)),inputOldField=$("#".concat(pageid," ").concat(SELECTORS_ROW_OLDINPUT)),tableRowName=$("#".concat(pageid," ").concat(SELECTORS_ROW_NAME)),pageNameLinkText=$("#".concat(pageid," ").concat(SELECTORS_ROW_PAGENAME)),pageModifiedDate=$("#".concat(pageid," ").concat(SELECTORS_MODIFIE_DDATE)),pagename=inputField.val();pagename.length>0&&(inputField[0].value=inputOldField.val(),Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_UPDATE_PAGE,config:JSON.stringify({id:pageid,pagename:pagename})},done:function(response){id=JSON.parse(response),pageNameLinkText.text(pagename),pageModifiedDate.text(dateModifier(Math.floor(Date.now()/1e3)))},fail:function(ex){Notification.exception(ex)}}]),tableRowName.removeClass("name_editing"))}function copyPageUrl(e){let pageid=$(this).data("value"),copyText=$("#".concat(pageid," ").concat(SELECTORS_TARGET_COPYURL));copyText.show(),copyText.select(),document.execCommand("copy"),copyText.hide(),showToastMessage(" ",LANGS[0])}function insertRowToTable(page){Templates.render("local_edwiserpagebuilder/site_page_table_single_row",{pages:page,config:M.cfg}).done((function(html,js){Templates.prependNodeContents($(".epb_table tbody"),html,js),$("html, body").animate({scrollTop:$(".epb_table")[0].offsetTop},$(window).scrollTop()/6)}))}function replicatePage(e){let pageid=$(this).data("value"),pagename=$("#".concat(pageid," ").concat(SELECTORS_ROW_PAGENAME)).text()+"_copy";Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_DUPLICATE_PAGE,config:JSON.stringify({id:pageid})},done:function(response){id=JSON.parse(response);let visible=!0;$("#".concat(pageid," ").concat(SELECTORS_HIDDEN_TAG)).length&&(visible=!1);let page={id:id,pagename:pagename,pageurl:"pagedraft.php?id="+id,indraft:!0,visible:visible,pagemodified:dateModifier(Math.floor(Date.now()/1e3))};if($("".concat(SELECTORS_PAGE_SUB_HEADER_MENUS," ").concat(SELECTORS_BTN_DUPLICATE)).length){showToastMessage(" ",LANGS[1]);let newUrl=M.cfg.wwwroot+"/local/edwiserpagebuilder/pagedraft.php?id="+id;window.open(newUrl,"_blank")}else insertRowToTable(page)},fail:function(ex){Notification.exception(ex)}}])}async function deletePage(e){let pageid=$(this).data("value"),currentPage=$("#"+pageid),tbody=currentPage.parent(),addPageRow=$(SELECTORS_ADD_PAGE_ROW);deletemodal=await ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:Str.get_string("pagedeletationmodalhead","local_edwiserpagebuilder"),body:Str.get_string("pagedeletationmodaldesc","local_edwiserpagebuilder")}).done((function(modal){modal.setButtonText("cancel",LANGS[5]),modal.setButtonText("save",LANGS[6]),modal.getRoot().on(ModalEvents.save,(function(){Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_DELETE_PAGE_RECORD,config:JSON.stringify({id:pageid})},done:function(response){response=JSON.parse(response),currentPage.remove(),1==tbody.children().length&&addPageRow.removeClass("d-none"),showToastMessage(" ",LANGS[2])},fail:function(ex){Notification.exception(ex)}}])})),modal.show()})),$(deletemodal.getActionSelector("cancel")).addClass("deletemodal-btns"),$(deletemodal.getActionSelector("save")).addClass("deletemodal-btns")}function publishCurrentPage(){let publishBtn=$(this),pageid=$(this).data("value"),indraft=void 0!==$(this).attr("indraft");ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:indraft?LANGS[9]:LANGS[11],body:indraft?LANGS[10]:LANGS[12]}).done((function(modal){modal.setButtonText("cancel",LANGS[5]),modal.setButtonText("save",LANGS[6]),modal.getRoot().on(ModalEvents.save,(function(){Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_PUBLISH_PAGE,config:JSON.stringify({id:pageid})},done:function(response){id=JSON.parse(response),$(SELECTORS_BTN_PUBLISH).text(LANGS[4]),publishBtn.removeAttr("indraft"),showToastMessage("",indraft?LANGS[3]:LANGS[13])},fail:function(ex){Notification.exception(ex)}}])})),modal.show()}))}function showAddPageInput(e){let addPageRow=$(SELECTORS_ADD_PAGE_ROW),inputField=$("".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_ROW_INPUT));$(addPageRow).removeClass("d-none");let tableRowName=$("".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_ROW_NAME));addPageRow.remove(),$(".epb_table tbody").prepend(addPageRow),$(SELECTORS_ROW_NAME).removeClass("name_editing"),$(tableRowName).addClass("name_editing"),inputField.focus()}function inputChangeHandler(e){let submitEdit=$(SELECTORS_BTN_SUBMITEDIT);$(this).val().length>0?submitEdit.removeClass("d-none"):submitEdit.addClass("d-none")}function addPageHandler(e){let inputField=$("".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_ROW_INPUT)),submitEdit=$("".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_BTN_SUBMITEDIT)),pagename=inputField.val();if(pagename.length>0){inputField[0].value="";let pagedata=JSON.stringify({pagename:pagename});Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_ADD_NEW_PAGE,config:pagedata},done:function(response){id=JSON.parse(response),$(SELECTORS_ADD_PAGE_ROW).addClass("d-none"),submitEdit.addClass("d-none"),insertRowToTable({id:id,pagename:pagename,pageurl:"pagedraft.php?id="+id,indraft:!0,visible:!0,pagemodified:dateModifier(Math.floor(Date.now()/1e3))})},fail:function(ex){Notification.exception(ex)}}])}}function makePageVisible(e){let pageid=$(this).data("value");Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_UPDATE_PAGE,config:JSON.stringify({id:pageid,visible:1})},done:function(response){id=JSON.parse(response),$("#".concat(pageid," ").concat(SELECTORS_BTN_EYECLOSE)).removeClass("d-none"),$("#".concat(pageid," ").concat(SELECTORS_BTN_EYE)).addClass("d-none"),$("#".concat(pageid," ").concat(SELECTORS_HIDDEN_TAG)).remove(),showToastMessage(" ",LANGS[8])},fail:function(ex){Notification.exception(ex)}}])}function makePageHidden(e){let pageid=$(this).data("value");Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:ACTION_UPDATE_PAGE,config:JSON.stringify({id:pageid,visible:0})},done:function(response){id=JSON.parse(response),$("#".concat(pageid," ").concat(SELECTORS_BTN_EYECLOSE)).addClass("d-none"),$("#".concat(pageid," ").concat(SELECTORS_BTN_EYE)).removeClass("d-none");let hiddenTag=$('\n                    <div class="btn-tag hidden-tag" title="'.concat(LANGS[7],'" >\n                        ').concat(LANGS[7],"\n                    </div>\n                "));$("".concat(SELECTORS_PAGE_SUB_HEADER," ").concat(SELECTORS_TAG_BOX)).append(hiddenTag),showToastMessage(" ",LANGS[8])},fail:function(ex){Notification.exception(ex)}}])}function initEvents(){Ajax.call([{methodname:"local_edwiserpagebuilder_do_page_action",args:{action:"sitepage_table_content",config:""},done:function(response){response=JSON.parse(response),$.each(response,(function(index,obj){-1==obj.refid?(obj.indraft=!0,obj.pageurl="pagedraft.php?id="+obj.id):obj.pageurl="page.php?id="+obj.refid,obj.visible=parseInt(obj.visible,10),obj.pagemodified=dateModifier(obj.pagemodified)})),Templates.render("local_edwiserpagebuilder/managepages",{pages:response,config:M.cfg}).done((function(html,js){Templates.appendNodeContents($("#managepage-wrapper"),html,js)}))},fail:function(ex){Notification.exception(ex)}}]),$(document).on("click","".concat(SELECTORS_TABLE_ROW," ").concat(SELECTORS_BTN_EDIT),showEditPagename),$(document).on("click","".concat(SELECTORS_TABLE_ROW," ").concat(SELECTORS_BTN_SUBMITEDIT),submitUpdatedPagename),$(document).on("input","".concat(SELECTORS_TABLE_ROW," ").concat(SELECTORS_ROW_INPUT),inputChangeHandler),$(document).on("keypress","".concat(SELECTORS_TABLE_ROW," ").concat(SELECTORS_ROW_INPUT),(function(e){if(13===e.which){e.preventDefault();submitUpdatedPagename(e,$(this).closest(".input-group").data("value"))}})),$(document).on("click","".concat(SELECTORS_TABLE_ROW," ").concat(SELECTORS_BTN_DELETE),deletePage),$(document).on("click",SELECTORS_BTN_ADDPAGE,showAddPageInput),$(document).on("input","".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_ROW_INPUT),inputChangeHandler),$(document).on("keypress","".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_ROW_INPUT),(function(e){13===e.which&&(e.preventDefault(),addPageHandler())})),$(document).on("click","".concat(SELECTORS_ADD_PAGE_ROW," ").concat(SELECTORS_BTN_SUBMITEDIT),addPageHandler)}function initCommon(){$(".page_sub_header").length&&setTimeout((function(){let pagesubheader=$(".page_sub_header");pagesubheader.remove(),$("#page-wrapper nav.navbar").after(pagesubheader);let navbarheight=$("#page-wrapper nav.navbar").height(),subpageheaderheight=$(".page_sub_header").height();$(".page_sub_header").css("margin-top",navbarheight),$("#page.drawers").css("margin-top",navbarheight+subpageheaderheight+20),$(".drawer-toggler").css("margin-top",navbarheight+subpageheaderheight)}),10),Str.get_strings(strings).then((function(results){return LANGS=results,results})),$(document).on("click",SELECTORS_BTN_COPYURL,copyPageUrl),$(document).on("click",SELECTORS_BTN_DUPLICATE,replicatePage),$(document).on("click",SELECTORS_BTN_PUBLISH,publishCurrentPage),$(document).on("click",SELECTORS_BTN_EYE,makePageVisible),$(document).on("click",SELECTORS_BTN_EYECLOSE,makePageHidden),$(window).on("beforeunload",(function(e){}))}return{init:function(){$(document).ready((function(){initEvents(),initCommon()}))},initCommon:function(){initCommon()}}}));

//# sourceMappingURL=pageslistsettings.min.js.map