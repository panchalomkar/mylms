define("local_edwiserpagebuilder/remuiblck/course_progress",["jquery","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/str","core_user/repository","core/modal_save_cancel","local_edwiserpagebuilder/remuiblck/dataTables.bootstrap4","local_edwiserpagebuilder/remuiblck/jquery-asPieProgress","local_edwiserpagebuilder/remuiblck/aspieprogress"],(function($,Ajax,Notification,Templates,ModalFactory,ModalEvents,Str,UserRepository){var SELECTORS_TABLE="#DataTables_Teacher",SELECTORS_DATA_TABLE="#DataTables_Teacher_wrapper",SELECTORS_STUDENT_PROGRESS_ELEMENT=".student_progress_ele",SELECTORS_STUDENT_PROGRESS_TABLE="#wdmCourseProgressTable",SELECTORS_COURSE_NAME=".wdm_course_name.has-student",SELECTORS_MESSAGE_HIDDEN="#messageidhidden",SELECTORS_MESSAGE_AREA="#messagearea",SELECTORS_TOGGLE_DESCRIPTION=".epb-toggle-desc",SELECTORS_REVERT="#courserevertbtn",SELECTORS_CUSTOM_MESSAGE=".custom-message",SELECTORS_MESSAGE_SEND=".send-message",SELECTORS_BLOCK_PROCESSING=".block-processing",SELECTORS_ALWAYS_LOAD="#always-load-progress",SELECTORS_COURSE_PROGRESSING=".course-progress-settings",SELECTORS_LOAD_COURSE_PROGRESS="#load-progress",SELECTORS_PANEL=".panel",SELECTORS_PANEL_HEADING=".panel-heading",SELECTORS_PANEL_ACTIONS="panel-actions",SELECTORS_STUDENT_PROOGRESS_VISIBLE="student-progress-visible",SELECTORS_DATATABLE_HEADER="#datatable_header";const strings=[{key:"searchforcourses",component:"local_edwiserpagebuilder"},{key:"datatableinfo",component:"local_edwiserpagebuilder"},{key:"search",component:"local_edwiserpagebuilder"},{key:"alwaysload",component:"local_edwiserpagebuilder"},{key:"alwaysloadwarning",component:"local_edwiserpagebuilder"},{key:"nomatchingcourses",component:"core_backup"},{key:"show",component:"moodle"},{key:"entries",component:"moodle"}];async function fetchLanguages(){await Str.get_strings(strings).then((function(results){return results,results}))}var courseProgressTable,DATA={coursesTable:[],alwaysloadwarning:!1},PROMISES_GET_COURSES=function(search,length,start,order,loadProgress){return Ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"get_course_progress_list",config:JSON.stringify({search:search,length:length,start:start,order:order,loadprogress:loadProgress})}}])[0]},PROMISES_GET_COURSE_PROGRESS=function(courseid){return Ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"get_course_progress",config:JSON.stringify({courseid:courseid})}}])[0]},PROMISES_SEND_MESSAGE=function(studentid,messagetext){return Ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"send_message",config:JSON.stringify({studentid:studentid,messagetext:messagetext})}}])[0]};function createDatatable(root,uniqid){DATA.coursesTable[uniqid]=$(root).show().find(SELECTORS_TABLE).DataTable({paging:!0,pagingType:"simple_numbers",autoWidth:!0,scrollX:!0,bPaginate:!0,bServerSide:!0,language:{searchPlaceholder:M.util.get_string("searchforcourses","local_edwiserpagebuilder"),emptyTable:M.util.get_string("nomatchingcourses","core_backup"),lengthMenu:M.util.get_string("show","moodle")+" _MENU_ "+M.util.get_string("entries","moodle"),info:M.util.get_string("datatableinfo","local_edwiserpagebuilder"),search:M.util.get_string("search","local_edwiserpagebuilder")+":",paginate:{first:"<span class='edw-icon fa fa-angle-left'></span>",previous:"<span class='edw-icon fa fa-angle-left'></span>",next:"<span class='edw-icon fa fa-angle-right'></span>",last:"<span class='edw-icon fa fa-angle-right'></span>"}},ajax:function(data,callback,settings){$(root).find(SELECTORS_BLOCK_PROCESSING).addClass("show");let loadCourseProgress=$(root+" "+SELECTORS_COURSE_PROGRESSING).is(".load-progress");PROMISES_GET_COURSES(data.search.value,data.length,data.start,data.order[0],loadCourseProgress).done((function(response){if(0==(response=JSON.parse(response)).recordsTotal)return response.data=[],callback(response),void $(root).find(SELECTORS_BLOCK_PROCESSING).removeClass("show");response.data=function(courses){var data=[];return courses.forEach((function(course){var dData={};dData.index='<div class="w-50" tabindex="0">'+course.index+"</div>",course.enrolledStudents>0?dData.course='<div class="wdm_course_name has-student" data-courseid="'+course.id+'"><a href="javascript:void(0)">'+course.fullname+"</a></div>":dData.course='<div class="wdm_course_name" data-courseid="'+course.id+'" >'+course.fullname+"</div>",dData.startdate=course.startdate,dData.students='<div class="w-100"><span class="w-full pl-40">'+course.enrolledStudents+"</span></div>",-1==course.percentage?dData.progress="":dData.progress='<td class="w-100 px-10"><div class="pie-progress pie-progress-xs m-0 w-35" data-plugin="pieProgress" data-valuemax="50" data-barcolor="#11c26d" data-size="20" data-barsize="3" data-goal="35" aria-valuenow="'+course.percentage+'" role="progressbar" style="max-width: 35px!important;"><div class="pie-progress-content" style="z-index:2;"> </div> <span class=" progress-percent" style="margin-left: 50px;position: absolute;top: 8px;">'+course.percentage+"%</span> </div></td>",data.push(dData)})),data}(response.courses),callback(response),$(root).find(SELECTORS_BLOCK_PROCESSING).removeClass("show")})).fail(Notification.exception)},columns:[{data:"index"},{data:"course"},{data:"startdate"},{data:"students",orderable:!1},{data:"progress",orderable:!1}],responsive:!0,drawCallback:function(settings){createPieProgress("",root),$(DATA.coursesTable[uniqid].table().header()).addClass("h-semibold-6")}})}function createPieProgress(target,root){var element=$(root);""!=target&&(element=element.find(target)),element.find(".pie-progress").asPieProgress({namespace:"pie-progress",speed:30,classes:{svg:"pie-progress-svg",element:"pie-progress",number:"pie-progress-number",content:"pie-progress-content"}})}function sendMessageToUser(studentid,message,root){PROMISES_SEND_MESSAGE(studentid,message).done((function(){!function(root){$(root).find(SELECTORS_MESSAGE_HIDDEN).val(""),$(root).find(SELECTORS_MESSAGE_AREA).val("")}(root),$(root).find(".close-message").click()})).fail((function(ex){Notification.exception(ex),$(root).find("div#analysis-chart-area").hide()}))}function toggleAlwaysLoading(checked,root,uniqid){"undefined"!=typeof rmblckmdlrelease&&rmblckmdlrelease<"4.3"?M.util.set_user_preference("always-load-progress",checked):UserRepository.setUserPreference("always-load-progress",checked),$(root).find(SELECTORS_COURSE_PROGRESSING).toggleClass("always-loading",checked),$(root).find(SELECTORS_COURSE_PROGRESSING).toggleClass("load-progress",checked),DATA.coursesTable[uniqid].draw()}function initializeEvents(root,uniqid){$("body").on("click",root+" "+SELECTORS_COURSE_NAME,(function(){!function(courseid,root){$(root).find(SELECTORS_BLOCK_PROCESSING).addClass("show"),PROMISES_GET_COURSE_PROGRESS(courseid).done((function(response){response=JSON.parse(response),Templates.render("local_edwiserpagebuilder/remuiblck/course_progress_view",response).done((function(html,js){$(root).find(SELECTORS_DATA_TABLE).hide(),Templates.replaceNodeContents($(root).find(SELECTORS_STUDENT_PROGRESS_ELEMENT),html,js),createPieProgress(SELECTORS_STUDENT_PROGRESS_ELEMENT,root),courseProgressTable=$(root).find(SELECTORS_STUDENT_PROGRESS_TABLE).DataTable({scrollY:"300px",scrollCollapse:!0,paging:!1,retrieve:!0,lengthchange:!1,autoWidth:!0,scrollX:!0,search:"Fred",info:!1,language:{searchPlaceholder:"Search"},responsive:!0}),$(root).find("div.dataTables_filter input").addClass("form-control"),$(root).find("div.dataTables_length select").addClass("form-control"),$(root).addClass(SELECTORS_STUDENT_PROOGRESS_VISIBLE),$(root).find(SELECTORS_BLOCK_PROCESSING).removeClass("show"),$("html, body").animate({scrollTop:$(root).offset().top-120},300)})).fail((function(){}))})).fail((function(){$(root).find("div#analysis-chart-area").hide()}))}($(this).data("courseid"),root)})).on("click",root+" "+SELECTORS_REVERT,(function(){courseProgressTable.destroy(),$(root).find(SELECTORS_STUDENT_PROGRESS_ELEMENT).empty(),$(root).find(SELECTORS_DATA_TABLE).show(),$(root).removeClass(SELECTORS_STUDENT_PROOGRESS_VISIBLE),$("html, body").animate({scrollTop:$(root).offset().top-120},300)})).on("click",root+" "+SELECTORS_CUSTOM_MESSAGE,(function(){var studentid=$(this).data("studentid");$(SELECTORS_MESSAGE_HIDDEN).val(studentid)})).on("click",root+" "+SELECTORS_MESSAGE_SEND,(function(){var studentid=$(root).find(SELECTORS_MESSAGE_HIDDEN).val(),message=$(root).find(SELECTORS_MESSAGE_AREA).val();""!=message?sendMessageToUser(studentid,message,root):$(SELECTORS_MESSAGE_AREA).focus()})).on("click",root+" "+SELECTORS_TOGGLE_DESCRIPTION,(function(){$(this).toggleClass("fa-plus"),$(this).toggleClass("fa-minus"),$(this).parents(SELECTORS_STUDENT_PROGRESS_ELEMENT).find(".panel-body").toggleClass("show")})).on("change",root+" "+SELECTORS_ALWAYS_LOAD,(function(){var checkbox=$(this),checked=$(this).is(":checked");!DATA.alwaysloadwarning&&checked?ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("alwaysload","local_edwiserpagebuilder"),body:M.util.get_string("alwaysloadwarning","local_edwiserpagebuilder")}).then((function(modal){var modalRoot=modal.getRoot();modalRoot.on(ModalEvents.save,(function(){DATA.alwaysloadwarning=!0,"undefined"!=typeof rmblckmdlrelease&&rmblckmdlrelease<"4.3"?M.util.set_user_preference("always-load-warning",!0):UserRepository.setUserPreference("always-load-warning",!0),toggleAlwaysLoading(checked,root,uniqid),modal.destroy()})),modalRoot.on(ModalEvents.cancel,(function(){checkbox.prop("checked",!1)})),modal.show()})):toggleAlwaysLoading(checked,root,uniqid)})).on("click",root+" "+SELECTORS_LOAD_COURSE_PROGRESS,(function(){$(root).find(SELECTORS_COURSE_PROGRESSING).addClass("load-progress"),DATA.coursesTable[uniqid].draw()})),$(root+" "+SELECTORS_TABLE).on("order.dt",(function(){createPieProgress("",root)})),$(root+" "+SELECTORS_STUDENT_PROGRESS_TABLE).on("order.dt",(function(){createPieProgress("",root)}))}var updateContainers=function(root){let button=$(root).find(SELECTORS_COURSE_PROGRESSING).detach(),panelHeading=$(root).closest(SELECTORS_PANEL).find(SELECTORS_PANEL_HEADING),panelActions=$(panelHeading).find("."+SELECTORS_PANEL_ACTIONS);0==panelActions.length&&(panelActions=$('<div class="'+SELECTORS_PANEL_ACTIONS+'"></div>'),panelHeading.append(panelActions)),$(root+" "+SELECTORS_DATATABLE_HEADER).append(button),button.removeClass("d-none").addClass("d-flex");let taskProcessing=$(root).find(SELECTORS_BLOCK_PROCESSING).detach();$(panelHeading).parent(SELECTORS_PANEL).prepend(taskProcessing)};return{init:async function(root){let alwaysloadwarning=arguments.length>1&&void 0!==arguments[1]&&arguments[1],uniqid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"1";await fetchLanguages(),DATA.alwaysloadwarning=alwaysloadwarning,$(document).ready((function(){createPieProgress("",root),createDatatable(root,uniqid),updateContainers(root),initializeEvents(root,uniqid)}))}}}));

//# sourceMappingURL=course_progress.min.js.map