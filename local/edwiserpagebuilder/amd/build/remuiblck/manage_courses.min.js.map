{"version":3,"file":"manage_courses.min.js","sources":["../../src/remuiblck/manage_courses.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable no-unused-vars */\n/* eslint-disable max-len */\n/* eslint-disable no-undef */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/modal_factory',\n    'core/modal_save_cancel',\n    'core/modal_events',\n    'core/templates',\n    'core/str',\n    'local_edwiserpagebuilder/remuiblck/chartjs',\n    'local_edwiserpagebuilder/remuiblck/jquery.dataTables',\n    'local_edwiserpagebuilder/remuiblck/dataTables.bootstrap4'\n], function(\n    $,\n    ajax,\n    Notification,\n    ModalFactory,\n    ModalSaveCancel,\n    ModalEvents,\n    Templates,\n    Str\n) {\n\n    var SELECTORS = {\n        ROOT: \"\",\n        VIEW_REPORT: '.epb-view-course-report',\n        STATS_TAB: '#wdm-userstats',\n        STATS_TABLE: '#userstats-table',\n        EXPORT_WRAPPER: '#userstats-table_wrapper .wdm-export-buttons',\n        EXPORT: '.wdm-manage-course-export-csv',\n        STATS_CHART: '#coursestats-chart',\n        STATS_FILTER_INPUT: '#userstats-table_filter input',\n        DROPPING_STUDENT_MESSAGE: '.dropping-student-message'\n    };\n\n    // ****** IMPORTANT ******\n    // Do not change the sequence.\n    // If you want to add new strings here, add it at the bottom.\n    // Do not remove any string from the array.\n    // There is no way we can revert back if sequence is changed.\n    // ****** IMPORTANT ******\n    const strings = [\n        {key: 'studentcompleted', component: 'local_edwiserpagebuilder'},\n        {key: 'inprogress', component: 'local_edwiserpagebuilder'},\n        {key: 'yettostart', component: 'local_edwiserpagebuilder'},\n        {key: 'searchnameemail', component: 'local_edwiserpagebuilder'},\n        {key: 'nostudentsenrolled', component: 'local_edwiserpagebuilder'},\n        {key: 'exportcsv', component: 'local_edwiserpagebuilder'},\n        {key: 'sendmessage', component: 'core_message'},\n        {key: 'send', component: 'core_message'},\n        {key: 'sendmessageto', component: 'core_message'}\n    ];\n\n    var LANGS; // Gloabl variable to store languages.\n\n    // Functionality to fetch strings.\n    // Functionality to fetch strings.\n    async function fetchLanguages() {\n        await Str.get_strings(strings).then(function(results) {\n            LANGS = results;\n            return results;\n        });\n    }\n\n    var PROMISES = {\n        /**\n         * Get course report promise\n         * @param  {int} courseid Course id\n         * @return {promise}           Ajax promise object\n         */\n        GET_COURSE_REPORT: function(courseid) {\n            return ajax.call([{\n                methodname: 'local_edwiserpagebuilder_remuiblck_action',\n                args: {\n                    action: \"get_course_report\",\n                    config: JSON.stringify({\n                        \"courseid\": courseid\n                    })\n                }\n            }])[0];\n        },\n\n        /**\n         * Get dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {String}  search   Search query\n         * @param {int}     length   Number of rows per page\n         * @param {int}     start    Starting row number\n         * @param {object}  order    Sorting order\n         * @return {promise}           Ajax promise object\n         */\n        GET_DROPPING_OFF_STUDENTS: function(courseid, search, length, start, order) {\n            return ajax.call([{\n                methodname: 'local_edwiserpagebuilder_remuiblck_action',\n                args: {\n                    action: \"get_dropping_off_students\",\n                    config: JSON.stringify({\n                        \"courseid\": courseid,\n                        \"search\": search,\n                        \"length\": length,\n                        \"start\": start,\n                        \"order\": order\n                    })\n                }\n            }])[0];\n        },\n\n        /**\n         * Export dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {string}  search   search query\n         * @return {promise}           Ajax promise object\n         */\n        EXPORT_DROPPING_OFF_STUDENTS: function(courseid, search) {\n            return ajax.call([{\n                methodname: 'local_edwiserpagebuilder_remuiblck_action',\n                args: {\n                    action: \"export_dropping_off_students\",\n                    config: JSON.stringify({\n                        \"courseid\": courseid,\n                        \"search\": search\n                    })\n                }\n            }])[0];\n        },\n        /**\n         * Send message to student using student id and ajax\n         * @param  {Number} studentid   Student id\n         * @param  {String} messagetext Message text\n         * @return {Promise}            Ajax promise\n         */\n        SEND_MESSAGE: function(studentid, messagetext) {\n            return ajax.call([{\n                methodname: 'local_edwiserpagebuilder_remuiblck_action',\n                args: {\n                    action: \"send_message\",\n                    config: JSON.stringify({\n                        \"studentid\": studentid,\n                        \"messagetext\": messagetext\n                    })\n                }\n            }])[0];\n        }\n    };\n\n    $('body').on('click', SELECTORS.ROOT + \" \" + SELECTORS.VIEW_REPORT, function() {\n        event.preventDefault();\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            title: $(_this).attr('title')\n        }, trigger).done(function(modal) {\n            modal.modal.addClass('modal-lg');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            }).addClass('fade');\n\n            // Show loading icon till load modal body\n            modal.setBody('<i class=\"fa fa-circle-o-notch fa-spin fa-fw\" aria-hidden=\"true\"></i>');\n\n            // Fetch body using ajax request\n            PROMISES.GET_COURSE_REPORT($(_this).data('course-id'))\n            .done(function(response) {\n                response = JSON.parse(response);\n                // modal.setBody(response);\n\n                let studentcompletedcolor = response.studentcompletedcolor,\n                inprogresscolor = response.inprogresscolor,\n                yettostartcolor = response.yettostartcolor;\n\n                Templates.render(\"local_edwiserpagebuilder/remuiblck/course_report\", response).done(function(html, js) {\n                    modal.setBody(html);\n                    if (modal.getRoot().find(SELECTORS.STATS_CHART).length != 0) {\n                        var ctx = modal.getRoot().find(SELECTORS.STATS_CHART)[0].getContext('2d');\n                        new Chart(ctx, {\n                            type: 'doughnut',\n                            data: {\n                                labels: [\n                                    M.util.get_string('studentcompleted', 'local_edwiserpagebuilder'),\n                                    M.util.get_string('inprogress', 'local_edwiserpagebuilder'),\n                                    M.util.get_string('yettostart', 'local_edwiserpagebuilder')\n                                ],\n                                datasets: [{\n                                    backgroundColor: [\n                                        studentcompletedcolor,\n                                        inprogresscolor,\n                                        yettostartcolor\n                                    ],\n                                    data: [\n                                        modal.getRoot().find(SELECTORS.STATS_CHART).data('studentcompleted'),\n                                        modal.getRoot().find(SELECTORS.STATS_CHART).data('inprogress'),\n                                        modal.getRoot().find(SELECTORS.STATS_CHART).data('yettostart')\n                                    ]\n                                }]\n                            },\n                            options: {\n                                legend: {\n                                    display: false\n                                }\n                            }\n                        });\n                    }\n                });\n                \n            })\n            .fail(Notification.exception);\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n        return;\n    }).on('click', SELECTORS.ROOT + \" \" + SELECTORS.STATS_TAB, function() {\n        if ($(SELECTORS.STATS_TABLE).is('.dataTable')) {\n            return;\n        }\n        $(SELECTORS.STATS_TABLE).DataTable({\n            \"bPaginate\": true,\n            \"bServerSide\": true,\n            \"language\": {\n                \"searchPlaceholder\": M.util.get_string('searchnameemail', 'local_edwiserpagebuilder'),\n                \"emptyTable\": M.util.get_string('nostudentsenrolled', 'local_edwiserpagebuilder')\n            },\n            \"dom\": '<\"wdm-export-buttons\">frtip',\n            \"initComplete\": function(settings, json) {\n                $(SELECTORS.EXPORT_WRAPPER).append(\n                    \"<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='\" + $(this).data('course-id') + \"'>\" + M.util.get_string(\n                        'exportcsv',\n                        'local_edwiserpagebuilder'\n                    ) + \"</button>\"\n                );\n            },\n            \"ajax\": function(data, callback, settings) {\n                PROMISES.GET_DROPPING_OFF_STUDENTS(\n                    $(this).data('course-id'),\n                    data.search.value,\n                    data.length,\n                    data.start,\n                    data.order[0]\n                ).done(function(response) {\n                    response = JSON.parse(response);\n                    callback(response);\n                }).fail(Notification.exception);\n            },\n            \"columns\": [\n                {\"className\": \"pb-0 pt-0\", \"data\": \"name\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"email\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"enroltimestart\"},\n                {\"className\": \"pb-0 pt-0\", \"data\": \"lastaccess\"}\n            ],\n            \"rowCallback\": function(row, data, index) {\n                if (index % 2 == 0) {\n                    $(row).addClass('bg-grey-100');\n                } else {\n                    $(row).addClass('bg-grey-200');\n                }\n            }\n        });\n    }).on('click', SELECTORS.ROOT + \" \" + SELECTORS.EXPORT, function() {\n        var _this = this;\n        PROMISES.EXPORT_DROPPING_OFF_STUDENTS(\n            $(_this).data('course-id'),\n            $(SELECTORS.STATS_FILTER_INPUT).val()\n        ).done(function(response) {\n            response = JSON.parse(response);\n            var file = $('<a></a>');\n            $('body').append(file);\n            $(file).attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(response.filedata));\n            $(file).attr('download', response.filename).hide()[0].click();\n            $(file).remove();\n        }).fail(Notification.exception);\n    }).on('click', SELECTORS.ROOT + \" \" + SELECTORS.DROPPING_STUDENT_MESSAGE, function() {\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: M.util.get_string('sendmessage', 'core_message')\n        }, trigger).done(function(modal) {\n\n            // Set button text as send\n            modal.setSaveButtonText(M.util.get_string('send', 'core_message'));\n\n            // Add textarea field in body\n\n            modal.setBody('<label>' + M.util.get_string('sendmessageto', 'core_message', $($(_this).parent('td').siblings()[0]).html()) + '</label><textarea class=\"form-control message\" rows=\"5\" autocomplete=\"off\"></textarea>');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            });\n\n            // Send message when save button is clicked\n            modal.getRoot().on(ModalEvents.save, function(event) {\n                var studentid = $(_this).data('student-id');\n                var message = $(this).find('.message').val();\n                if (message != '') {\n                    PROMISES.SEND_MESSAGE(studentid, message)\n                    .done(function(response) {\n                        modal.destroy();\n                    })\n                    .fail(function(ex) {\n                        Notification.exception(ex);\n                    });\n                }\n            }).addClass('modal-success fade');\n            modal.modal.addClass('modal-center');\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n    });\n\n    var init = async function(root) {\n        await fetchLanguages();\n        SELECTORS.ROOT = root;\n        $(document).ready(function() {\n            $(root).on('click', \".menu-picker-select\", function() {\n                $(this).find(\".menu-content\").toggleClass('d-none');\n                $(this).find(\".showmenuoption\").toggleClass('d-none');\n                $(this).find(\".hidemenuoption\").toggleClass('d-none');\n            });\n        });\n    };\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","ajax","Notification","ModalFactory","ModalSaveCancel","ModalEvents","Templates","Str","SELECTORS","ROOT","VIEW_REPORT","STATS_TAB","STATS_TABLE","EXPORT_WRAPPER","EXPORT","STATS_CHART","STATS_FILTER_INPUT","DROPPING_STUDENT_MESSAGE","strings","key","component","PROMISES","courseid","call","methodname","args","action","config","JSON","stringify","search","length","start","order","studentid","messagetext","on","event","preventDefault","_this","this","trigger","create","title","attr","done","modal","addClass","getRoot","hidden","destroy","setBody","data","response","studentcompletedcolor","parse","inprogresscolor","yettostartcolor","render","html","js","find","ctx","getContext","Chart","type","labels","M","util","get_string","datasets","backgroundColor","options","legend","display","fail","exception","setTimeout","show","is","DataTable","settings","json","append","callback","value","row","index","val","file","encodeURIComponent","filedata","filename","hide","click","remove","types","SAVE_CANCEL","setSaveButtonText","parent","siblings","save","message","ex","init","async","root","get_strings","then","results","fetchLanguages","document","ready","toggleClass"],"mappings":"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"}