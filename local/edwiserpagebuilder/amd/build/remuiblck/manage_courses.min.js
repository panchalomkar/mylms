define("local_edwiserpagebuilder/remuiblck/manage_courses",["jquery","core/ajax","core/notification","core/modal_factory","core/modal_save_cancel","core/modal_events","core/templates","core/str","local_edwiserpagebuilder/remuiblck/chartjs","local_edwiserpagebuilder/remuiblck/jquery.dataTables","local_edwiserpagebuilder/remuiblck/dataTables.bootstrap4"],(function($,ajax,Notification,ModalFactory,ModalSaveCancel,ModalEvents,Templates,Str){var SELECTORS={ROOT:"",VIEW_REPORT:".epb-view-course-report",STATS_TAB:"#wdm-userstats",STATS_TABLE:"#userstats-table",EXPORT_WRAPPER:"#userstats-table_wrapper .wdm-export-buttons",EXPORT:".wdm-manage-course-export-csv",STATS_CHART:"#coursestats-chart",STATS_FILTER_INPUT:"#userstats-table_filter input",DROPPING_STUDENT_MESSAGE:".dropping-student-message"};const strings=[{key:"studentcompleted",component:"local_edwiserpagebuilder"},{key:"inprogress",component:"local_edwiserpagebuilder"},{key:"yettostart",component:"local_edwiserpagebuilder"},{key:"searchnameemail",component:"local_edwiserpagebuilder"},{key:"nostudentsenrolled",component:"local_edwiserpagebuilder"},{key:"exportcsv",component:"local_edwiserpagebuilder"},{key:"sendmessage",component:"core_message"},{key:"send",component:"core_message"},{key:"sendmessageto",component:"core_message"}];var PROMISES_GET_COURSE_REPORT=function(courseid){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"get_course_report",config:JSON.stringify({courseid:courseid})}}])[0]},PROMISES_GET_DROPPING_OFF_STUDENTS=function(courseid,search,length,start,order){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"get_dropping_off_students",config:JSON.stringify({courseid:courseid,search:search,length:length,start:start,order:order})}}])[0]},PROMISES_EXPORT_DROPPING_OFF_STUDENTS=function(courseid,search){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"export_dropping_off_students",config:JSON.stringify({courseid:courseid,search:search})}}])[0]},PROMISES_SEND_MESSAGE=function(studentid,messagetext){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"send_message",config:JSON.stringify({studentid:studentid,messagetext:messagetext})}}])[0]};$("body").on("click",SELECTORS.ROOT+" "+SELECTORS.VIEW_REPORT,(function(){event.preventDefault();var _this=this,trigger=$("#create-modal");ModalFactory.create({title:$(_this).attr("title")},trigger).done((function(modal){modal.modal.addClass("modal-lg"),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})).addClass("fade"),modal.setBody('<i class="fa fa-circle-o-notch fa-spin fa-fw" aria-hidden="true"></i>'),PROMISES_GET_COURSE_REPORT($(_this).data("course-id")).done((function(response){let studentcompletedcolor=(response=JSON.parse(response)).studentcompletedcolor,inprogresscolor=response.inprogresscolor,yettostartcolor=response.yettostartcolor;Templates.render("local_edwiserpagebuilder/remuiblck/course_report",response).done((function(html,js){if(modal.setBody(html),0!=modal.getRoot().find(SELECTORS.STATS_CHART).length){var ctx=modal.getRoot().find(SELECTORS.STATS_CHART)[0].getContext("2d");new Chart(ctx,{type:"doughnut",data:{labels:[M.util.get_string("studentcompleted","local_edwiserpagebuilder"),M.util.get_string("inprogress","local_edwiserpagebuilder"),M.util.get_string("yettostart","local_edwiserpagebuilder")],datasets:[{backgroundColor:[studentcompletedcolor,inprogresscolor,yettostartcolor],data:[modal.getRoot().find(SELECTORS.STATS_CHART).data("studentcompleted"),modal.getRoot().find(SELECTORS.STATS_CHART).data("inprogress"),modal.getRoot().find(SELECTORS.STATS_CHART).data("yettostart")]}]},options:{legend:{display:!1}}})}}))})).fail(Notification.exception),setTimeout(modal.show(),100)}))})).on("click",SELECTORS.ROOT+" "+SELECTORS.STATS_TAB,(function(){$(SELECTORS.STATS_TABLE).is(".dataTable")||$(SELECTORS.STATS_TABLE).DataTable({bPaginate:!0,bServerSide:!0,language:{searchPlaceholder:M.util.get_string("searchnameemail","local_edwiserpagebuilder"),emptyTable:M.util.get_string("nostudentsenrolled","local_edwiserpagebuilder")},dom:'<"wdm-export-buttons">frtip',initComplete:function(settings,json){$(SELECTORS.EXPORT_WRAPPER).append("<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='"+$(this).data("course-id")+"'>"+M.util.get_string("exportcsv","local_edwiserpagebuilder")+"</button>")},ajax:function(data,callback,settings){PROMISES_GET_DROPPING_OFF_STUDENTS($(this).data("course-id"),data.search.value,data.length,data.start,data.order[0]).done((function(response){response=JSON.parse(response),callback(response)})).fail(Notification.exception)},columns:[{className:"pb-0 pt-0",data:"name"},{className:"pb-0 pt-0",data:"email"},{className:"pb-0 pt-0",data:"enroltimestart"},{className:"pb-0 pt-0",data:"lastaccess"}],rowCallback:function(row,data,index){index%2==0?$(row).addClass("bg-grey-100"):$(row).addClass("bg-grey-200")}})})).on("click",SELECTORS.ROOT+" "+SELECTORS.EXPORT,(function(){PROMISES_EXPORT_DROPPING_OFF_STUDENTS($(this).data("course-id"),$(SELECTORS.STATS_FILTER_INPUT).val()).done((function(response){response=JSON.parse(response);var file=$("<a></a>");$("body").append(file),$(file).attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(response.filedata)),$(file).attr("download",response.filename).hide()[0].click(),$(file).remove()})).fail(Notification.exception)})).on("click",SELECTORS.ROOT+" "+SELECTORS.DROPPING_STUDENT_MESSAGE,(function(){var _this=this,trigger=$("#create-modal");ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("sendmessage","core_message")},trigger).done((function(modal){modal.setSaveButtonText(M.util.get_string("send","core_message")),modal.setBody("<label>"+M.util.get_string("sendmessageto","core_message",$($(_this).parent("td").siblings()[0]).html())+'</label><textarea class="form-control message" rows="5" autocomplete="off"></textarea>'),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.getRoot().on(ModalEvents.save,(function(event){var studentid=$(_this).data("student-id"),message=$(this).find(".message").val();""!=message&&PROMISES_SEND_MESSAGE(studentid,message).done((function(response){modal.destroy()})).fail((function(ex){Notification.exception(ex)}))})).addClass("modal-success fade"),modal.modal.addClass("modal-center"),setTimeout(modal.show(),100)}))}));return{init:async function(root){await async function(){await Str.get_strings(strings).then((function(results){return results,results}))}(),SELECTORS.ROOT=root,$(document).ready((function(){$(root).on("click",".menu-picker-select",(function(){$(this).find(".menu-content").toggleClass("d-none"),$(this).find(".showmenuoption").toggleClass("d-none"),$(this).find(".hidemenuoption").toggleClass("d-none")}))}))}}}));

//# sourceMappingURL=manage_courses.min.js.map