"undefined"!=typeof rmblckmdlrelease&&rmblckmdlrelease<"4.3"?moduleDependencies=["jquery","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/fragment","core/str","local_edwiserpagebuilder/remuiblck/modal_task_popup","local_edwiserpagebuilder/remuiblck/events","local_edwiserpagebuilder/remuiblck/task_filters","local_edwiserpagebuilder/remuiblck/task_view"]:moduleDependencies=["jquery","core/ajax","core/notification","core/templates","local_edwiserpagebuilder/remuiblck/modal_factory","core/modal_events","core/fragment","core/str","local_edwiserpagebuilder/remuiblck/modal_task_popup","local_edwiserpagebuilder/remuiblck/events","local_edwiserpagebuilder/remuiblck/task_filters","local_edwiserpagebuilder/remuiblck/task_view"],define("local_edwiserpagebuilder/remuiblck/task",moduleDependencies,(function($,ajax,Notification,Templates,ModalFactory,ModalEvents,Fragment,Str,ModalTaskPopup,RemuiblckEvents,TaskFilters,TaskView){var SELECTORS_ADD_TASK='[data-region="add-schedule-task"]',SELECTORS_TASK='[data-region="task-item"]',SELECTORS_TASK_EDIT='[data-action="edit"]',SELECTORS_TASK_SUBJECT$0=".item-title .panel-heading span",SELECTORS_TOASTER_CONTAINER="[aria-task-toasters]",SELECTORS_TOASTER_CONTAINER_ID="aria-task-toasters";const strings=[{key:"deletetask",component:"local_edwiserpagebuilder"},{key:"deletetaskmessage",component:"local_edwiserpagebuilder"},{key:"taskdeleted",component:"local_edwiserpagebuilder"},{key:"ok",component:"moodle"}];var PROMISES_CREATE_NEW_TASK=function(settings){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"create_new_task",config:JSON.stringify(settings)}}])[0]},PROMISES_EDIT_TASK=function(settings){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"edit_task",config:JSON.stringify(settings)}}])[0]},PROMISES_COMPLETE_TASK=function(taskid,status){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"complete_task",config:JSON.stringify({id:taskid,status:status})}}])[0]},PROMISES_DELETE_TASK=function(taskid){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"delete_task",config:JSON.stringify({id:taskid})}}])[0]},PROMISES_NOTIFY_USERS=function(taskid,type){return ajax.call([{methodname:"local_edwiserpagebuilder_remuiblck_action",args:{action:"task_notify_users",config:JSON.stringify({id:taskid,type:type})}}])[0]},FRAGMENTS_GET_TASK_FORM=function(taskid){return Fragment.loadFragment("local_edwiserpagebuilder","task_form",contextid,{taskid:taskid})},closeTaskPopup=function(modal){modal.hide(),modal.destroy()},deleteTask=function(root,taskid,taskModal){let subject=function(root,taskid){let task=$(root).find(SELECTORS_TASK+'[data-id="'+taskid+'"]');return task?task.find(SELECTORS_TASK_SUBJECT$0).text():taskid}(root,taskid);ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:M.util.get_string("deletetask","local_edwiserpagebuilder"),body:M.util.get_string("deletetaskmessage","local_edwiserpagebuilder",subject)},$("#create")).done((function(modal){modal.setSaveButtonText(M.util.get_string("ok","moodle")),modal.getRoot().on(ModalEvents.save,(function(){PROMISES_DELETE_TASK(taskid).done((function(response){if(1==(response=JSON.parse(response)).status)return closeTaskPopup(modal),closeTaskPopup(taskModal),setTimeout((function(){closeTaskPopup(modal)}),200),setTimeout((function(){closeTaskPopup(taskModal)}),200),loadTasks(root),void function(root,position,type,message){0==$(root).find("."+position+SELECTORS_TOASTER_CONTAINER).length&&$(root).append('<div class="toaster '+position+'"'+SELECTORS_TOASTER_CONTAINER_ID+'role="alert"></div>');let newToast=$('<div class="toast toast-just-text '+type+' toast-shadow"><div class="toast-message">'+message+"</div></div>");$(root).find(SELECTORS_TOASTER_CONTAINER).append(newToast),setTimeout((function(){newToast.addClass("show")}),0),setTimeout((function(){newToast.removeClass("show"),setTimeout((function(){newToast.remove()}),250)}),2e3)}(root,"toast-top-center","toast-error",M.util.get_string("taskdeleted","local_edwiserpagebuilder",subject));Notification.exception({name:response.msg})})).fail(Notification.exception)})).on(ModalEvents.cancel,(function(){closeTaskPopup(modal)})),modal.show()})).fail(Notification.exception)},taskPopup=function(root,taskid){ModalFactory.create({type:ModalTaskPopup.TYPE,templateContext:{new:-1==taskid}},$("#create")).done((function(modal){modal.show(),modal.setBody(FRAGMENTS_GET_TASK_FORM(taskid)),modal.getRoot().on(ModalEvents.hidden,(function(){closeTaskPopup(modal)})).on(RemuiblckEvents.TASK_SAVE,(function(){if(!modal.valid_settings())return;modal.saving();let settings=modal.get_task_settings();-1!=taskid?(settings.id=taskid,PROMISES_EDIT_TASK(settings).done((function(){closeTaskPopup(modal),loadTasks(root)})).fail((function(ex){modal.saving(!1),Notification.exception(ex)}))):PROMISES_CREATE_NEW_TASK(settings).done((function(response){response=JSON.parse(response),1!=settings.notify?(closeTaskPopup(modal),loadTasks(root)):function(taskid,type){var callback=arguments.length>1&&void 0!==arguments[2]?arguments[2]:null;PROMISES_NOTIFY_USERS(taskid,type).done(callback).fail((function(ex){Notification.exception(ex),null!=callback&&callback()}))}(response,"create",(function(){closeTaskPopup(modal),loadTasks(root)}))})).fail((function(ex){modal.saving(!1),Notification.exception(ex)}))})).on(RemuiblckEvents.TASK_DELETE,(function(){deleteTask(root,taskid,modal)})).on(RemuiblckEvents.TASK_CANCEL,(function(){closeTaskPopup(modal)}))}))},loadTasks=function(root){TaskView.loadTasks(root,TaskFilters.getTaskDuration(root),TaskFilters.getTaskStatus(root))},initialiseEvents=function(root){$("body").on("click",root+" "+SELECTORS_ADD_TASK,(function(){taskPopup(root,-1)})).on("click",root+" "+SELECTORS_TASK,(function(e){$(e.target).is("input")?function(root,taskid,status){TaskView.toggleTaskProcessing(root,!0),PROMISES_COMPLETE_TASK(taskid,status).done((function(response){1!=(response=JSON.parse(response)).status?($(root+" "+SELECTORS_TASK+'[data-id="'+taskid+'"]').find("input").prop("checked",!status),Notification.exception({name:response.msg}),TaskView.toggleTaskProcessing(root)):loadTasks(root)})).fail((function(ex){Notification.exception(ex),$(root+" "+SELECTORS_TASK+'[data-id="'+taskid+'"]').find("input").prop("checked",!status),TaskView.toggleTaskProcessing(root)}))}(root,$(this).data("id"),$(e.target).is(":checked")):$(e.target).is(SELECTORS_TASK_SUBJECT$0)||($(e.target).is(SELECTORS_TASK_EDIT)||$(e.target).parent().is(SELECTORS_TASK_EDIT))&&taskPopup(root,$(this).data("id"))}))};return{init:async function(root){await async function(){await Str.get_strings(strings).then((function(results){return results,results}))}(),$(document).ready((function(){initialiseEvents(root)})),TaskView.init(root),TaskFilters.init(root)}}}));

//# sourceMappingURL=task.min.js.map