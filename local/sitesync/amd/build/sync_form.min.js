/**
 * @module     local_sitesync/sync_form
 * @copyright (c) 2020 WisdmLabs (https://wisdmlabs.com/)
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_sitesync/sync_form",["jquery","core/ajax","core/modal","core/notification","local_sitesync/connection","core/toast"],(function($,ajax,Modal,Notification,Connection,Toast){var SELECTORS={GENERATE_KEY_BTN:"#generateKey",SECURE_KEY_INPUT:"#secureKeyInput",COPY_KEY_BTN:"#secureKeyGroup .copyicon",START_SYNC_BTN:"#startSync",SELECT_ALL:'input[name="select_all"]',CONFIG_INPUT:"#ConfigSelector .configinput",ADD_PUBLIC_KEY:"#addPublicKey",PUBLIC_KEY_INPUT:"#publicKeyInput",USER_NOTIFICATION:"#region-main #user-notifications",SYNC_PROGRESS_TRACKER:".syncprogresstracker",NAV_TABS_LINK:".local_sitesync .nav-tabs .nav-link",NO_CONNECTION_OVERLAY:".no-connection-overlay"};const registerEvents=()=>{$(SELECTORS.GENERATE_KEY_BTN).on("click",(()=>{ajax.call([{methodname:"local_sitesync_generate_keys",args:{},done:response=>{$(SELECTORS.SECURE_KEY_INPUT).val(response.publickey);var msg=M.util.get_string("keygeneratedsuccessfully","local_sitesync");Toast.add(msg,{delay:3e3,closeButton:!0,type:"success sitesync_key_toast"})},fail:()=>{SELECTORS.GENERATE_KEY_BTN.disabled=!1}}])})),$(SELECTORS.COPY_KEY_BTN).on("click",(function(){var clipboardText;clipboardText=$(SELECTORS.SECURE_KEY_INPUT).val();const temp=$("<textarea>");$("body").append(temp),temp.val(clipboardText).select(),document.execCommand("copy"),temp.remove();var msg=M.util.get_string("textcopied","local_sitesync");Toast.add(msg,{delay:3e3,closeButton:!0,type:"warning sitesync_key_toast"})})),$(SELECTORS.SELECT_ALL).on("click",(function(){var isChecked=$(this).is(":checked");$(SELECTORS.CONFIG_INPUT).prop("checked",isChecked)})),$(SELECTORS.CONFIG_INPUT).on("click",(function(){var checkboxes=$(SELECTORS.CONFIG_INPUT);$(SELECTORS.SELECT_ALL).prop("checked",checkboxes.length===checkboxes.filter(":checked").length)})),$(SELECTORS.START_SYNC_BTN).on("click",(async()=>{await setupSyncEnvironment()})),$(document).on("keyup",SELECTORS.PUBLIC_KEY_INPUT,(function(){const inputValue=$(this).val().trim();$(SELECTORS.ADD_PUBLIC_KEY).prop("disabled",""===inputValue)})),$(document).on("click","".concat(SELECTORS.ADD_PUBLIC_KEY),(async()=>{if(input_public_key_modal){var configdata={key:"master_secret_pub_key",value:$(SELECTORS.PUBLIC_KEY_INPUT).val(),plugin:"local_sitesync"};await Connection.saveConfigs([configdata]),input_public_key_modal.destroy();let syncconfig=await Connection.getSyncConfigs();syncconfig=JSON.parse(syncconfig),sync_start(syncconfig.masterkey)}})),$(SELECTORS.NAV_TABS_LINK).on("click",(async()=>{Connection.getConnectionStatus()?$(SELECTORS.NO_CONNECTION_OVERLAY).addClass("d-none"):$(SELECTORS.NO_CONNECTION_OVERLAY).removeClass("d-none")}))},sync_start=async masterkey=>{$(SELECTORS.START_SYNC_BTN).attr("disabled","disabled");let themesyncdata=await prepareSyncData(masterkey);if(themesyncdata){themesyncdata=JSON.parse(themesyncdata);let args={action:"sync_settings_on_master",config:JSON.stringify({themeselectedConfigs:themesyncdata,pluginname:"theme_remui",masterkey:masterkey})};if(connectionstatus){let serverconfig=await Connection.getSyncConfigs();$(SELECTORS.USER_NOTIFICATION).empty(),await get_notification(M.util.get_string("syncinprogress","local_sitesync"),"warning"),$(SELECTORS.SYNC_PROGRESS_TRACKER).removeClass("d-none"),await syncSettingsOnMaster(JSON.parse(serverconfig),args)}else $(SELECTORS.USER_NOTIFICATION).empty(),await get_notification(M.util.get_string("mastersitenotavailable","local_sitesync"),"danger")}else $(SELECTORS.USER_NOTIFICATION).empty(),await get_notification(M.util.get_string("noconfigurationselected","local_sitesync"),"danger")},prepareSyncData=async masterkey=>{let selectedConfigs=[];if(selectedConfigs=$(SELECTORS.CONFIG_INPUT+":checked").map((function(){return $(this).attr("name")})).get(),!selectedConfigs.length)return!1;const request={methodname:"local_sitesync_do_sync_action",args:{action:"prepare_sync_data",config:JSON.stringify({themeselectedConfigs:selectedConfigs,pluginname:"theme_remui",masterkey:masterkey})}};return await ajax.call([request])[0]},get_notification=async(message,type)=>{await Notification.addNotification({message:message,type:type})},syncSettingsOnMaster=async(serverconfig,args)=>{const progress=baseprogress=>baseprogress+Date.now()%5;updateProgress(0);const wsUrl="".concat(serverconfig.siteurl,"/webservice/rest/server.php"),formData=new FormData;formData.append("wstoken",serverconfig.accesstoken),formData.append("wsfunction","local_sitesync_do_sync_action"),formData.append("moodlewsrestformat","json"),formData.append("action",args.action),formData.append("config",args.config),updateProgress(progress(10)),fetch(wsUrl,{method:"POST",body:formData}).then((response=>(updateProgress(progress(60)),response.json()))).then((async data=>{updateProgress(progress(75));let responsedata=JSON.parse(data);if("success"==responsedata.status)updateProgress(100),$(SELECTORS.START_SYNC_BTN).removeAttr("disabled"),$(SELECTORS.USER_NOTIFICATION).empty(),get_notification(M.util.get_string("synccompleted","local_sitesync"),"success"),Connection.remUiActiveState()||get_notification(M.util.get_string("remuinotactivenotification","local_sitesync"),"warning"),setTimeout((()=>{$(".typeform-wrapper button.typeform-init-button").click()}),1e3);else{get_notification(responsedata.message,"danger"),master_public_key=!1,$(SELECTORS.START_SYNC_BTN).removeAttr("disabled");await Connection.saveConfigs([{key:"master_secret_pub_key",value:" ",plugin:"local_sitesync"}])}return!0})).catch((error=>{Notification.addNotification({message:"Something went wrong "+error.message+" Please try again later.",type:"error"})}))};let input_public_key_modal=!1;const updateProgress=progress=>{$("".concat(SELECTORS.SYNC_PROGRESS_TRACKER," .progress-bar")).css("width",progress+"%").attr("aria-valuenow",progress).text(progress+"%")},setupSyncEnvironment=async()=>{if(!Connection.getConnectionStatus())throw Notification.addNotification({message:"Cannot stat sync process no connection found",type:"error"}),new Error("Cannot start sync process no connection found");master_public_key?sync_start(master_public_key):input_public_key_modal=await(async()=>{const modal=await Modal.create({title:"".concat(M.util.get_string("addpublickeyinfo2","local_sitesync")),body:"<p>".concat(M.util.get_string("addpublickeyinfo","local_sitesync"),'</p><input type="password" id="publicKeyInput" class="form-control" placeholder="Secret public key"  required/>'),footer:'<button type="button" class="btn btn-primary" id="addPublicKey" disabled>'.concat(M.util.get_string("startsyncbtntext","local_sitesync"),"</button>"),show:!0,removeOnClose:!0});return modal.show(),modal})()};return{init:()=>{registerEvents()}}}));

//# sourceMappingURL=sync_form.min.js.map