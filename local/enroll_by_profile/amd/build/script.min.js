define(["jquery","jqueryui","theme_remui/bootbox","theme_remui/notify","core/str","core/templates","core/notification","core/ajax"],function(e,t,n,l,o,a,i,r){function c(e,t){n.confirm({size:"small",message:e,callback:t})}o.get_strings([{key:"no_rule_selected",component:"local_enroll_by_profile"},{key:"confirm_message_disable_selected_rule",component:"local_enroll_by_profile"},{key:"confirm_message_keepenroll_selected_rule",component:"local_enroll_by_profile"},{key:"confirm_message_keepunenroll_selected_rule",component:"local_enroll_by_profile"},{key:"error5",component:"local_enroll_by_profile"},{key:"errorname",component:"local_enroll_by_profile"},{key:"errornamechar",component:"local_enroll_by_profile"}]);return{init:function(){e(document).ready(function(){var t,n=(t=0,function(e,n){clearTimeout(t),t=setTimeout(e,n)});e(document).on("keyup","#search",function(){var t=e(this).val().toLowerCase(),i=l("page");n(function(){var n={methodname:"local_enroll_by_profile_search",args:{search_value:t,search_page:i}};r.call([n])[0].done(function(n){a.render("local_enroll_by_profile/enrollbyprofile",n).done(function(n){t?e("#rules_table .pagination").hide():e("#rules_table .pagination").show(),e("#id_elements_content").empty(),e("#mortalEngines").html(n),d(),T()})}).fail(function(t){var n=o.get_string("no_rules","local_enroll_by_profile");e.when(n).done(function(t){e("#mortalEngines").html(t)}),console.log("error is "+t)})},800)});var l=function(e){var t,n,l=window.location.search.substring(1).split("&");for(n=0;n<l.length;n++)if((t=l[n].split("="))[0]===e)return void 0===typeof t[1]||decodeURIComponent(t[1]);return!1};e(document).on("click",".checkAll",function(t){if(this.checked){e(".selectall").prop("checked",!0),e(".delete_rule_all").css("pointer-events","auto"),e(".disable_rule_all").css("pointer-events","auto"),e("#choise_select").val(0);var n=new Array;e(".selectall:checked").each(function(){n.push(e(this).attr("data-ruleid"))}),e("#choise_selected").val(n)}else e(".selectall").prop("checked",!1),e("#choise_select").val(0),e("#choise_selected").val(" "),i=[]});var i=[];function d(){var t=e(".keepunenroll").length,n=e(".keepunenroll:checked").length,l=e(".keepunenroll:checkbox:not(:checked)").length;if(n>=1){var a=o.get_string("checked_all","local_enroll_by_profile");e.when(a).done(function(t){e(".unenrollAll").attr("title",t)}),e(".unenrollAll").prop("checked",!0)}if(0==n){var i=o.get_string("unchecked_all","local_enroll_by_profile");e.when(i).done(function(t){e(".unenrollAll").attr("title",t)}),e(".unenrollAll").prop("checked",!1)}if(n===t){a=o.get_string("checked_all","local_enroll_by_profile");e.when(a).done(function(t){e(".unenrollAll").attr("title",t)}),e(".unenrollAll").prop("checked",!0)}if(l===t){i=o.get_string("unchecked_all","local_enroll_by_profile");e.when(i).done(function(t){e(".unenrollAll").attr("title",t)}),e(".unenrollAll").prop("checked",!1)}}function s(){r.call([{methodname:"local_enroll_by_profile_addcond",args:{condid:1}}])[0].done(function(t){a.render("local_enroll_by_profile/newcondition_form",t).done(function(n){e(".conditions-view").empty(),e(".conditions-view").append(t.rowdata.boolop_html),e(".conditions-view").append(n),e(".btn-delete").off().on("click",g),e("#id_conditions_num").val(id),e(".boolopstch").off("click").on("click",m),e(".profile-field").off().on("change",p),e("input[name=negated]").off().on("click",k),b(),conditions=w(),C(conditions)})}).fail(function(e){console.log("error is "+e)})}e(document).on("click",".selectall",function(t){var n,l,o,a=e(".selectall").length,r=e(".selectall:checked").length,c=e(this).attr("id");if(c=c.replace(/[^0-9.]/g,""),this.checked){var d=e("#choise_selected").val();(i=d.split(",")).push(c),e("#choise_selected").val(i)}else{var s;s=e("#choise_selected").val().split(","),l=c,(o=(n=s).indexOf(l))>-1&&n.splice(o,1),e("#choise_selected").val(s)}a==r?(e(".checkAll").prop("checked",!0),e(".delete_rule_all").css("pointer-events","auto"),e(".disable_rule_all").css("pointer-events","auto")):(e(".checkAll").prop("checked",!1),e(".delete_rule_all").css("pointer-events","auto"),e(".disable_rule_all").css("pointer-events","auto"),e("#choise_select").val(0))}),e(document).on("click","a.add.rules_btn.delete_rule_all",function(t){t.preventDefault();var n=e("#choise_select").val(),l=e("#choise_selected").val(),o=new Array;if(e(".selectall:checked").each(function(){o.push(e(this).attr("data-ruleid"))}),0==o.length)e(".error_notification").html(M.util.get_string("no_rule_selected","local_enroll_by_profile")),e(".error_notification").addClass("alert alert-danger");else{e(".error_notification").html(""),e(".error_notification").removeClass("alert alert-danger");c(M.util.get_string("confirm_message_delete_rule","local_enroll_by_profile"),function(t){if(t){var o={methodname:"local_enroll_by_profile_delete_rule_btn",args:{allselect:n,selectedrule:l}};r.call([o])[0].done(function(t){e.each(t,function(t,n){"msg"==t&&e("#label_notify").text(n)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),window.location.href=M.cfg.wwwroot+"/local/enroll_by_profile/index.php"}).fail(function(e){console.log("error is "+e)})}})}}),d(),e(document).on("click",".unenrollAll",function(t){if(this.checked){t.preventDefault();c(M.util.get_string("confirm_message_keepunenroll_selected_rule","local_enroll_by_profile"),function(n){if(n){t.preventDefault();var l=new Array;e("input[type=checkbox]").each(function(){l.push(e(this).attr("data-ruleid"))}),t.preventDefault();var a={methodname:"local_enroll_by_profile_keep_unenroll_all",args:{rid:l}};r.call([a])[0].done(function(t){var n=o.get_string("keep_unenroll","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),location.reload()}).fail(function(e){console.log("error is "+e)})}else e(this).prop("checked",!1)})}else{t.preventDefault();c(M.util.get_string("confirm_message_keepenroll_selected_rule","local_enroll_by_profile"),function(n){if(n){t.preventDefault();var l=new Array;e("input[type=checkbox]").each(function(){l.push(e(this).attr("data-ruleid"))}),t.preventDefault();var a={methodname:"local_enroll_by_profile_keep_enroll_all",args:{rid:l}};r.call([a])[0].done(function(t){var n=o.get_string("keep_enroll","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),location.reload()}).fail(function(e){console.log("error is "+e)}),location.reload()}else e(this).prop("checked",!1)})}}),e(document).on("click",".keepunenroll",function(t){var n=this.checked?"checked":"unchecked";if("unchecked"==n){var l=e(this).attr("data-ruleid");t.preventDefault();c(M.util.get_string("confirm_message_keepenroll_selected_rule","local_enroll_by_profile"),function(t){if(t){var n={methodname:"local_enroll_by_profile_keep_enroll",args:{rid:l}};r.call([n])[0].done(function(t){var n=o.get_string("keep_enroll","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),location.reload()}).fail(function(e){console.log("error is "+e)}),location.reload()}else e(this).prop("checked",!1)})}else if("checked"==n){l=e(this).attr("data-ruleid");t.preventDefault();c(M.util.get_string("confirm_message_keepunenroll_selected_rule","local_enroll_by_profile"),function(t){if(t){var n={methodname:"local_enroll_by_profile_keep_unenroll",args:{rid:l}};r.call([n])[0].done(function(t){var n=o.get_string("keep_unenroll","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),location.reload()}).fail(function(e){console.log("error is "+e)}),location.reload()}else e(this).prop("checked",!1)})}}),e(document).on("keyup","#search_cat",function(){var t=e(this).val().toLowerCase();e("#id_elements_content div label").filter(function(){e(this).toggle(e(this).text().toLowerCase().indexOf(t)>-1)}),e(".emptyrow").hide()}),e("#id_category_type").on("change",function(){var t=e(this).val(),n={methodname:"local_enroll_by_profile_get_category",args:{category:t}};r.call([n])[0].done(function(n){var l="";1==t?l="get_courses":2==t?l="get_tenant":3==t?l="get_lp":4==t?l="get_cohort":5==t?l="get_role":6==t&&(l="get_learning_plans"),a.render("local_enroll_by_profile/"+l,n).done(function(t){e("#id_elements_content").empty(),e("#id_elements_content").append(t)})}).fail(function(e){console.log("error is "+e)})}),e.datepicker.setDefaults({changeMonth:!0,changeYear:!0,onSelect:function(t,n){var l=e(this).parent().parent().parent().parent().parent(),o=[];if(l.hasClass("condition-item")){var a=l.attr("data-id"),i=l.find("[type=hidden]").val(),r=l.find("[type=hidden]").attr("name");o.push(t)}else{var a=l.parent().attr("data-id"),i=l.parent().find("[type=hidden]").val(),r=l.parent().find("[type=hidden]").attr("name");if(e(this).hasClass("end_date")){var c=e(this).parent().parent().parent().find(".start_date").val();o.push(c),o.push(t)}else{var c=e(this).parent().parent().parent().find(".end_date").val();o.push(t),o.push(c)}}e(".condition-item[data-id="+a+"]").attr("data-value",JSON.stringify(o)),e(".condition-item[data-id="+a+"]").attr("data-negatedrule",r),e(".condition-item[data-id="+a+"]").attr("data-negatedstatement",i),conditions=w(),C(conditions)}});var _=e(".profile-field").attr("data-id");function u(t){var n=e(t.currentTarget);if(n.hasClass("interval")){var l=[],o=n.parent().parent().parent().attr("data-id"),a=n.parent().parent().parent().children("[type=hidden]").val(),i=n.parent().parent().parent().children("[type=hidden]").attr("name"),r=e("#id_content"+o).val()||"",c=e("#id_subcontent"+o).val()||"";n.attr("id")=="id_subcontent"+o?c=n.val():r=n.val(),l.push(r),l.push(c)}else{l=[],o=n.parent().parent().attr("data-id"),a=n.parent().parent().children("[type=hidden]").val(),i=n.parent().parent().children("[type=hidden]").attr("name");l.push(n.val())}e(".condition-item[data-id="+o+"]").attr("data-value",JSON.stringify(l)),e(".condition-item[data-id="+o+"]").attr("data-negatedrule",i),e(".condition-item[data-id="+o+"]").attr("data-negatedstatement",a),conditions=w(),C(conditions)}e("#id_profile_field"+_).on("change",function(){"checkbox"===e("option:selected","#id_profile_field"+_).attr("data-type")?e("#conditional_actions"+_+" label").hide():e("#conditional_actions"+_+" label").show(),e("#id_content").removeAttr("readonly"),e("#id_category_type").attr("disabled",!1)}),e("#id_content").on("blur",function(){e("#id_content").val()?e("#id_category_type").attr("disabled",!1):e("#id_category_type").attr("disabled",!0)}),e(".content-value").on("keyup",u),e(document).on("change",".select-conditional",function(){e(".content-select").on("change",u),"isselected"==e(".condition-item[data-id="+_+"]").attr("data-rule")&&e(".condition-item[data-id="+_+"]").attr("data-value",'["'+e("#id_content"+_).val()+'"]'),"role"===e("#id_profile_field"+_).val()?e("#id_input_role_shortname_label").css("display","block"):e("#id_input_role_shortname_label").css("display","none")}),e(document).on("click",".content-select",function(){var t=e(".condition-item[data-id="+_+"]").attr("data-rule");e(".content-select").on("change",u),e(".condition-item[data-id="+_+"]").attr("data-value",'["'+e("#id_content"+_).val()+'"]'),"hasanyselected"==t&&(conditions=w(),C(conditions))}),e("#id_content").on("keyup",function(){e("#id_content").val()?e("#id_category_type").attr("disabled",!1):e("#id_category_type").attr("disabled",!0)}),e("#saveelements").click(function(t){e("#wait").css("display","block");var n=e(".rule_statement").text(),l=e(".namerule").val();if(""==l)return e("#alert_content").empty(),e("#alert_content").parent(".alert").css("display","block"),e("#alert_content").html(M.util.get_string("errorname","local_enroll_by_profile")),e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in"),e("#alert_content").parent(".alert").slideUp(3e3,function(){e("#done_alert").slideUp(3e3)}),e("#wait").css("display","none"),!1;if(l.length>100)return e("#alert_content").empty(),e("#alert_content").parent(".alert").css("display","block"),e("#alert_content").html(M.util.get_string("errornamechar","local_enroll_by_profile")),e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in"),e("#alert_content").parent(".alert").slideUp(3e3,function(){e("#done_alert").slideUp(3e3)}),e("#wait").css("display","none"),!1;var a=w(),i=e("#id_category_type").val(),c=function(e){var t="",n=0;return e.forEach(function(e){switch(0!==n&&("AND"===e.boolop?t+=" AND ":t+=" OR "),n++,1==e.negated||"true"==e.negated?e.negatedrule:e.rule){case"contains":t+="(",t+="`"+e.field+"`",t+=" LIKE '%"+e.value+"%' ",t+=")";break;case"beginswith":t+="(",t+="`"+e.field+"`",t+=" LIKE '"+e.value+"%' ",t+=")";break;case"endswith":t+="(",t+="`"+e.field+"`",t+=" LIKE '%"+e.value+"' ",t+=")";break;case"isempty":t+="(",t+="`"+e.field+"`",t+=" =  '' ",t+=")";break;case"exactmatch":case"equalsto":t+="(",t+="`"+e.field+"`",t+=" = '"+e.value+"'",t+=")";break;case"notlessthan":case"greaterorequalthan":t+="(",t+="`"+e.field+"`",t+=" >= '"+e.value+"'",t+=")";break;case"notlessorequalthan":case"greaterthan":t+="(",t+="`"+e.field+"`",t+=" > '"+e.value+"'",t+=")";break;case"notgreaterthan":case"lessorequalthan":t+="(",t+="`"+e.field+"`",t+=" <= '"+e.value+"'",t+=")";break;case"notgreaterorequalthan":case"lessthan":t+="(",t+="`"+e.field+"`",t+=" < '"+e.value+"'",t+=")";break;case"isbefore":t+="(",t+="`"+e.field+"`",t+=" < date('"+e.value+"')",t+=")";break;case"isafter":t+="(",t+="`"+e.field+"`",t+=" > date('"+e.value+"')",t+=")";break;case"isbetween":t+="(",t+="`"+e.field+"`",t+=" > date('"+e.value[0]+"')",t+=" AND `"+e.field+"`",t+=" < date('"+e.value[1]+"')",t+=")";break;case"itson":t+="(",t+="`"+e.field+"`",t+=" = date('"+e.value+"')",t+=")";break;case"ischecked":case"isnotchecked":t+="(",t+="`"+e.field+"`",t+=")";break;case"isselected":t+="(",t+="`"+e.field+"`",t+=" = '"+e.value+"'",t+=")";break;case"notisselected":t+="(",t+="`"+e.field+"`",t+=" != '"+e.value+"'",t+=")";break;case"hasselected":case"hasanyselected":t+="(",t+="`"+e.field+"`",t+=" = '"+e.value+"'",t+=")";break;case"notcontains":t+="(",t+="`"+e.field+"`",t+=" NOT LIKE '%"+e.value+"%'",t+=")";break;case"notbeginswith":t+="(",t+="`"+e.field+"`",t+=" NOT LIKE '"+e.value+"%'",t+=")";break;case"notendswith":t+="(",t+="`"+e.field+"`",t+=" = '"+e.value+"'",t+=")";break;case"notisempty":t+="(",t+="`"+e.field+"`",t+=" != ''",t+=")";break;case"notequalsto":t+="(",t+="`"+e.field+"`",t+=" != '"+e.value+"'",t+=")";break;case"notisbefore":case"notisafter":t+="(",t+="`"+e.field+"`",t+=" >= date('"+e.value+"')",t+=")";break;case"notisbetween":t+="(",t+="`"+e.field+"`",t+=" < date('"+e.value[0]+"')",t+=" AND `"+e.field+"`",t+=" > date('"+e.value[1]+"')",t+=")";break;case"notitson":t+="(",t+="`"+e.field+"`",t+=" != date('"+e.value+"')",t+=")"}}),t}(a);if(a.length<1){e("#alert_content").empty(),e("#alert_content").html(M.util.get_string("check_condition_create_update","local_enroll_by_profile")),e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in");var d=o.get_string("rulesuccessalert","local_enroll_by_profile");return e.when(d).done(function(t){e("#label_notify").html(t)}),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)}),!1}if(2!=i){var s=new Array,_=document.getElementsByName("elements[]"),u=e("#id_profile_field").val(),p=e("#content_input_element"),m=p.find("input");0==m.length&&0==(m=p.find("select")).length&&(m=p.find("textarea"));var h="";h+="[{";for(var g=0;g<=m.length-1;g++)e(m[g]).val()&&("radio"==e(m[g])[0].type?e(m[g])[0].checked&&(h+=e(m[g]).attr("name")+":"+e(m[g]).val()+","):e(m[g]).val()&&(h+=e(m[g]).attr("name")+":"+e(m[g]).val()+","));h+="}]";for(g=0;g<_.length;g++)_[g].checked&&s.push(_[g].value);u=JSON.stringify(a),emptyconditions=[];for(g=0;g<a.length;g++)0==a[g].value.length&&emptyconditions.push(a[g]);if(("isempty"!=a[0].rule||"isempty"!=emptyconditions[0].rule)&&emptyconditions.length>0){e("#alert_content").empty(),e("#alert_content").html("you still have "+emptyconditions.length+" empty conditions");for(g=0;g<emptyconditions.length;g++)e(".condition-item[data-id="+emptyconditions[g].id+"]").addClass("border-danger");return e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in"),e("#alert_content").parent(".alert").fadeTo(4e3,500).slideUp(500,function(){for(var t=0;t<emptyconditions.length;t++)e(".condition-item[data-id="+emptyconditions[t].id+"]").removeClass("border-danger");e("#wait").css("display","none"),e("#done_alert").slideUp(500)}),!1}if(h=v=c,!(s.length>0))return e("#alert_content").empty(),e("#alert_content").html(M.util.get_string("error"+i,"local_enroll_by_profile")),e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in"),e("#alert_content").parent(".alert").fadeTo(4e3,500).slideUp(500,function(){e("#wait").css("display","none"),e("#done_alert").slideUp(500)}),!1;if(e("#id_editrule").val())f(s,i,u,v,e("#id_editrule").val(),n,l);else if(!e("#id_editrule").val()){f(s,i,u,h,0,n,l)}d=o.get_string("rulesuccessalert","local_enroll_by_profile");e.when(d).done(function(t){e("#label_notify").html(t)}),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)})}else if(2==i){s=new Array,_=e("#selected_tenant").val(),u=e("#id_profile_field").val();var v=e("#id_content").val();if("object"==typeof v){h="";h+="[{content:";for(g=0;g<=v.length-1;g++)h+=v[g]+",";v=h+="}]"}if(u=JSON.stringify(a),v=c,_)if(s.push(_),e("#id_editrule").val())f(s,i,u,v,e("#id_editrule").val(),n,l);else{if(e("#id_editrule").val())return e("#alert_content").empty(),e("#alert_content").html(M.util.get_string("error"+i,"local_enroll_by_profile")),e("#alert_content").parent(".alert").removeClass("out"),e("#alert_content").parent(".alert").addClass("in"),e("#alert_content").parent(".alert").slideUp(500,function(){e("#done_alert").slideUp(500)}),e("#wait").css("display","none"),!1;f(s,i,u,v,0,n,l)}e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#done_alert").slideUp(500)})}r.call([{methodname:"local_enroll_by_profile_action_count",args:{}}])[0].done(function(t){var n=JSON.stringify(t);e("#id_rulescount").val(n)}).fail(function(e){console.log("error is "+e)}),e("#wait").css("display","none"),setTimeout(function(){T()},500)});function f(t,n,l,o,a,i,c){var d={methodname:"local_enroll_by_profile_save_category",args:{category:n,elements:t,prof_field:l,content:o,rid:a,rulename:i,name:c}};r.call([d])[0].done(function(t){e("#enroll_by_profile_modal").modal("toggle"),s(),e("#rules_table").load(window.location+" #rules_table")}).fail(function(e){console.log("error is "+e)})}function p(t){var n=e("option:selected",this).attr("data-type"),l=e("option:selected",this).val(),o=e(this).attr("data-id");e(".condition-item[data-id="+o+"]").attr("data-field",l);var i={methodname:"local_enroll_by_profile_conditional_html",args:{fieldselected:"yes",fieldsn:l,fieldtype:n,condid:o}};r.call([i])[0].done(function(t){a.render("local_enroll_by_profile/get_conditional_html",t).done(function(t){e("#content_conditional_element"+o).empty(),e("#id_category_type").attr("disabled",!1),e("#content_conditional_element"+o).html(t),e(".datepicker").datepicker({format:"m/d/yyyy",autoclose:!0,todayHighlight:!0}),e(".select-conditional").on("change",v),conditions=w(),C(conditions)})}).fail(function(e){console.log("error is "+e)}),e(".select-conditional").on("change",v),conditions=w(),C(conditions)}function m(t){var n=e(t.currentTarget),l=n.parent().attr("data-id"),o="",a=e(".condition-item[data-id="+l+"]"),i=e(a[0]);o="AND"===i.attr("data-boolop")?"OR":"OR"===i.attr("data-boolop")?"AND":"",i.attr("data-boolop",o),n.text(o),C(a=w())}function h(){return cont=parseInt(e("#id_conditions_num").val())||1,cont++,cont}function g(t){var n=e(t.currentTarget).parent().parent().attr("data-id");e("[data-id="+n+"]").remove(),b(),conditions=w(),C(conditions)}function v(t){var n=e(t.currentTarget).parent().parent().attr("data-id"),l=e("option:selected","#id_profile_field"+n).attr("data-type"),o=e("option:selected","#id_profile_field"+n).val(),i=e("option:selected",t.currentTarget).val(),c=e("option:selected",t.currentTarget).text();e(".condition-item[data-id="+n+"]").attr("data-rule",i),e(".condition-item[data-id="+n+"]").attr("data-statement",c);var d={methodname:"local_enroll_by_profile_input_html",args:{conditional:i,fieldsn:o,fieldtype:l,condid:n}};r.call([d])[0].done(function(t){templatename="contains"==i||"beginswith"==i||"endswith"==i||"exactmatch"==i?"condition_contains":"greaterthan"==i||"lessorequalthan"==i||"greaterorequalthan"==i||"lessthan"==i||"equalsto"==i?"condition_greaterthan":"insideinterval"==i?"condition_insideinterval":"isbetween"==i?"condition_isbetween":"isbefore"==i?"condition_isbefore":"isafter"==i?"condition_isafter":"itson"==i?"condition_itson":"isselected"==i?"condition_isselected":"hasanyselected"==i||"hasselected"==i?"condition_hasanyselected":"menu"==i?"condition_menu":"ischecked"==i||"isnotchecked"==i||"isempty"==i?"multiple_conditions":"",""!=templatename&&null!=templatename&&a.render("local_enroll_by_profile/"+templatename,t).done(function(t){e("#content_input_element"+n).empty(),e("#content_input_element"+n).html(t),"condition_isselected"==templatename&&e(".condition-item[data-id="+n+"]").attr("data-value",'["'+e("#id_content"+n).val()+'"]'),y(n),e(".content-value").off().on("keyup",u),e("input[name=negated]").off().on("click",k),e(".datepicker").datepicker({format:"m/d/yyyy",autoclose:!0,todayHighlight:!0})}),y(n),e(".content-value").off().on("keyup",u),e("input[name=negated]").off().on("click",k),e(".datepicker").datepicker({format:"m/d/yyyy",autoclose:!0,todayHighlight:!0})}).fail(function(e){console.log("error is "+e)}),conditions=w(),C(conditions)}function y(t){var n={methodname:"local_enroll_by_profile_conditional_buttons",args:{buttons:"true",condid:t}};r.call([n])[0].done(function(t){a.render("local_enroll_by_profile/action_buttons",t).done(function(t){e("#conditional_actions").html(t),e(".btn-add-condition").on("click",U)}),e("#conditional_actions").html(t.responseText),e(".btn-add-condition").on("click",U)}).fail(function(e){console.log("error is "+e)})}function b(){var t=e(".conditions-view").children(":first"),n=t.attr("data-id");t.children(".boolopstch").length>0?(t.remove(),e(".condition-item[data-id="+n+"]").attr("data-boolop",""),e(".condition-item[data-id="+n+"]").attr("data-text","")):check=!1}function k(t){var n=e(t.currentTarget),l=n.parent().parent().attr("data-id"),o=e(".condition-item[data-id="+l+"]");n.is(":checked")?o.attr("data-negated",!0):o.attr("data-negated",!1),conditions=w(),C(conditions)}function w(){var t=[];return e(".condition-item").each(function(){condition={},condition.id=e(this).attr("data-id"),condition.field=e(this).attr("data-field"),condition.boolop=e(this).attr("data-boolop"),condition.value=JSON.parse(e(this).attr("data-value")),condition.rule=e(this).attr("data-rule"),condition.negatedrule=e(this).attr("data-negatedrule"),condition.negatedstatement=e(this).attr("data-negatedstatement"),condition.statement=e(this).attr("data-statement"),condition.negated=e(this).attr("data-negated"),condition.text=x(condition),t.push(condition)}),t}function x(e){return"ischecked"===e.rule&&(e.value[0]=""),"isnotchecked"===e.rule&&(e.value[0]=""),text="<strong>"+e.boolop+"</strong>",text+="<em> "+e.field+"</em><strong> ",1==e.negated||"true"==e.negated?text+=e.negatedstatement+"</strong> <em>":text+=e.statement+"</strong> <em>","isempty"===e.rule?text+="</em>":e.value.length>1?text+=e.value[0]+" and "+e.value[1]+"</em>":text+=e.value[0]+"</em>",text}function U(){conditions=w(),condition={},condition.id=h(),condition.boolop=e("option:selected","#id_boolop").text()||"",condition.field=e("option:selected","#id_profile_field").val(),condition.value=e(".content-select").val(),e(".end_date").val()?condition.value=[e(".start_date").val(),e(".end_date").val()]:e(".start_date").val()?condition.value=e(".start_date").val():e(".content-value").val()?condition.value=e(".content-value").val():e(".content-select").val()?condition.value=e(".content-select").val():condition.value="",condition.negated=e("#id_negated").is(":checked"),condition.rule=e("#id_conditional").val(),condition.negatedstatement=e("#id_negatedrule").val(),condition.negatedrule=e("#id_negatedrule").attr("name"),condition.statement=e("option:selected","#id_conditional").text(),condition.text=x(condition),conditions.push(condition),e("#id_conditions_num").val(condition.id),A(conditions),C(conditions),r.call([{methodname:"local_enroll_by_profile_bool_opdropdown",args:{dropdown:"true"}}])[0].done(function(t){a.render("local_enroll_by_profile/get_bool_opdropdown",t).done(function(n){conditions=w(),conditions.length>0?e(".boolop").html(t.responseText):e(".boolop").html("")}),conditions=w(),conditions.length>0?e(".boolop").html(t.responseText):e(".boolop").html("")}).fail(function(e){console.log("error is "+e)}),e("#content_conditional_type").html(html_type_default),e("#content_input_element").html(html_input_default),e("#content_conditional_element").html(html_cond_default),e("#conditional_actions").empty(),e("#id_profile_field").val("0"),e(".btn-delete").on("click",g)}function A(t){e(".conditions-view").html(""),e(t).each(function(t,n){var l=n.id,o=JSON.stringify(n),i={methodname:"local_enroll_by_profile_addcond",args:{condid:l,params:o}};r.call([i])[0].done(function(t){a.render("local_enroll_by_profile/newcondition_form",t).done(function(t){e(".conditions-view").append(t),e(".profile-field[data-id="+l+"]").val(n.field);var o=e("option:selected","#id_profile_field"+l).attr("data-type"),i={methodname:"local_enroll_by_profile_conditional_html",args:{fieldselected:"yes",fieldsn:n.field,fieldtype:o,condid:l}};r.call([i])[0].done(function(t){a.render("local_enroll_by_profile/get_conditional_html",t).done(function(t){e("#content_conditional_element"+l).empty(),e("#content_conditional_element"+l).html(t);var i={methodname:"local_enroll_by_profile_input_html",args:{conditional:n.rule,fieldsn:n.field,fieldtype:o,condid:l}};r.call([i])[0].done(function(t){"contains"==n.rule||"beginswith"==n.rule||"endswith"==n.rule||"exactmatch"==n.rule?templatename="condition_contains":"greaterthan"==n.rule||"lessorequalthan"==n.rule||"greaterorequalthan"==n.rule||"lessthan"==n.rule||"equalsto"==n.rule?templatename="condition_greaterthan":"insideinterval"==n.rule?templatename="condition_insideinterval":"isselected"==n.rule?templatename="condition_isselected":"hasanyselected"==n.rule||"hasselected"==n.rule?templatename="condition_hasanyselected":"menu"==n.rule?templatename="condition_menu":"ischecked"==n.rule||"isnotchecked"==n.rule||"isempty"==n.rule?templatename="multiple_conditions":"isbetween"==n.rule?templatename="condition_isbetween":"isbefore"==n.rule?templatename="condition_isbefore":"isafter"==n.rule?templatename="condition_isafter":"itson"==n.rule?templatename="condition_itson":templatename="",""!=templatename||null!=templatename?a.render("local_enroll_by_profile/"+templatename,t).done(function(t){e("#content_input_element"+l).empty(),e("#content_input_element"+l).html(t),e("#id_conditional"+l).val(n.rule),"condition_isselected"==templatename&&e(".condition-item[data-id="+l+"]").attr("data-value",'["'+e("#id_content"+l).val()+'"]'),values=n.value,e(".btn-delete").off().on("click",g),e("#id_conditions_num").val(l),e(".profile-field").off().on("change",p),e(".select-conditional").on("change",v),b(),e(".boolopstch").off("click").on("click",m),e("input[name=negated]").off().on("click",k),e(".content-value").off().on("keyup",u),values.length>1?(e("#id_content"+l).val(values[0]),e("#id_subcontent"+l).val(values[1])):e("#id_content"+l).val(values[0]),e(".datepicker").datepicker({format:"m/d/yyyy",autoclose:!0,todayHighlight:!0})}):(e("#content_input_element"+l).empty(),e("#content_input_element"+l).html(jqXHR.responseText)),values=n.value,e(".btn-delete").off().on("click",g),e("#id_conditions_num").val(l),e(".profile-field").off().on("change",p),e(".select-conditional").on("change",v),b(),e(".boolopstch").off("click").on("click",m),e("input[name=negated]").off().on("click",k),e(".content-value").off().on("keyup",u),values.length>1?(e("#id_content"+l).val(values[0]),e("#id_subcontent"+l).val(values[1])):e("#id_content"+l).val(values[0]),e(".datepicker").datepicker({format:"m/d/yyyy",autoclose:!0,todayHighlight:!0})}).fail(function(e){console.log("error is "+e)})})}).fail(function(e){console.log("error is "+e)})})}).fail(function(e){console.log("error is "+e)})})}function C(t){var n="";e(t).each(function(e,t){n+='<span class="muted-text" data-id="'+t.id+'">'+x(t)+"</span>&nbsp;&nbsp;"}),e(".rule_statement").html(n)}function T(){e("body#page-local-enroll_by_profile-index tr").each(function(){var t=e(this).find(".collapse").attr("id");e("#"+t+" a").length>0?e(this).find("i").addClass("showicon"):e(this).find("i").addClass("hideicon")})}r.call([{methodname:"local_enroll_by_profile_action_count",args:{}}])[0].done(function(t){var n=JSON.stringify(t);e("#id_rulescount").val(n)}).fail(function(e){console.log("error is "+e)}),e("#wait").css("display","none"),e("#id_elements_content").on("click","label.form-checkbox",function(){e(this).hasClass("active")?(e(this).removeClass("active"),e(this).children("input").prop("checked",!1)):(e(this).addClass("active"),e(this).children("input").prop("checked",!0))}),e("#rules_table").on("click","a.disable_rule",function(t){t.preventDefault();var n=0;n=e(this).data("ruleid"),t.preventDefault();c("Are you sure, you want to disable this rule ?",function(t){if(t){var l={methodname:"local_enroll_by_profile_disable_rule",args:{rid:n}};r.call([l])[0].done(function(t){var n=o.get_string("ruledisablealert","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)})}).fail(function(e){console.log("error is "+e)}),location.reload()}})}),e(document).on("click","a.disable_rule_all",function(t){var n=e("#choise_select").val(),l=e("#choise_selected").val(),a=new Array;if(e(".selectall:checked").each(function(){a.push(e(this).attr("data-ruleid"))}),0==a.length)e(".error_notification").html(M.util.get_string("no_rule_selected","local_enroll_by_profile")),e(".error_notification").addClass("alert alert-danger");else{e(".error_notification").html(""),e(".error_notification").removeClass("alert alert-danger"),t.preventDefault();c(M.util.get_string("confirm_message_disable_selected_rule","local_enroll_by_profile"),function(t){if(t){var a={methodname:"local_enroll_by_profile_disable_all_rule",args:{allselect:n,selectedrule:l}};r.call([a])[0].done(function(t){var n=e(".ruledisable").length;if(0==parseInt(n))var l=o.get_string("ruledisablealert","local_enroll_by_profile");else var l=o.get_string("ruleenablealert","local_enroll_by_profile");e.when(l).done(function(t){e("#label_notify").html(t)}),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)})}).fail(function(e){console.log("error is "+e)}),location.reload()}})}}),e("#rules_table").on("click","a.enable_rule",function(t){t.preventDefault();var n=0;n=e(this).data("ruleid"),t.preventDefault();c("Are you sure you want to enable this rule ?",function(t){if(t){var l={methodname:"local_enroll_by_profile_enable_rule",args:{rid:n}};r.call([l])[0].done(function(t){var n=o.get_string("ruleenablealert","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)})}).fail(function(e){console.log("error is "+e)}),location.reload()}})}),e("#rules_table").on("click","a.delete_rule",function(t){t.preventDefault();var n=0;n=e(this).data("ruleid"),t.preventDefault();c(M.util.get_string("confirm_message_delete_rule","local_enroll_by_profile"),function(t){if(t){e("#wait").css("display","block");var l={methodname:"local_enroll_by_profile_delete_rule",args:{rid:n}};r.call([l])[0].done(function(t){var n=o.get_string("deleterecord","local_enroll_by_profile");e.when(n).done(function(t){e("#label_notify").html(t)}),e("#rules_table").load(window.location+" #rules_table"),e("#done_alert").fadeTo(2e3,500).slideUp(500,function(){e("#label_notify").text(""),e("#done_alert").slideUp(500)});r.call([{methodname:"local_enroll_by_profile_action_count",args:{}}])[0].done(function(t){var n=JSON.stringify(t);e("#id_rulescount").val(n)}).fail(function(e){console.log("error is "+e)})}).fail(function(e){console.log("error is "+e)}),location.reload()}var a,i,c=e("#id_rulescount").val(),d=window.location.search.substring(1).split("&");for(i=0;i<d.length;i++)(a=d[i].split("="))[0]===page&&(void 0===a[1]||decodeURIComponent(a[1]));if(c%10==0&&0!=a[1]){var s=location.href.replace("page="+a[1],"page="+(a[1]-1));window.location=s}e("#wait").css("display","none")})}),e("#rules_table").on("click","a.edit_rule",function(t){t.preventDefault();var n=e(this).data("ruletoedit");e(".modal-title").text("Edit A rule");var l={methodname:"local_enroll_by_profile_edit_rule",args:{rid:n}};r.call([l])[0].done(function(t){var l=t.table,o=t.fieldtype,i=(t.html,l[0].profile_field),c=l[0].category,d=l[0].selected_elements;A(JSON.parse(i)),C(JSON.parse(i)),e(".btn-delete").off().on("click",g),e("#id_content").removeAttr("readonly"),e("#id_category_type").attr("disabled",!1),e("#id_editrule").val(n);var s=l[0].name;e("#id_name_field1").val(s),function(t){switch(t){case"datetime":e("#id_content_title").html(M.util.get_string("content_title_between","local_enroll_by_profile"));break;case"menu":case"checkbox":e("#id_content_title").html(M.util.get_string("content_title_equal_to","local_enroll_by_profile"));break;case"text":case"textarea":case"multiselectlist":case"multiselect":e("#id_content_title").html(M.util.get_string("content_title_contain","local_enroll_by_profile"))}}(o),e("#id_content_title").show(),e("#id_category_type").val(c);var _={methodname:"local_enroll_by_profile_get_category",args:{category:c,selected:d}};1==c?templatename="get_courses":2==c?templatename="get_tenant":3==c?templatename="get_lp":4==c?templatename="get_cohort":5==c?templatename="get_role":6==c&&(templatename="get_learning_plans"),r.call([_])[0].done(function(t){a.render("local_enroll_by_profile/"+templatename,t).done(function(t){var n=l[0].name;e("#id_name_field1").val(n),e("#id_elements_content").empty(),e("#id_elements_content").html(t)}),e("#id_elements_content").empty(),e("#id_elements_content").html(t)}).fail(function(e){console.log("error is "+e)})}).fail(function(e){console.log("error is "+e)})}),e("input[name=negated]").off().on("click",k),e(".btn-add-cond").on("click",function(){var t=h(),n={methodname:"local_enroll_by_profile_addcond",args:{condid:t}};r.call([n])[0].done(function(n){a.render("local_enroll_by_profile/newcondition_form",n).done(function(l){e(".conditions-view").append(n.rowdata.boolop_html),e(".conditions-view").append(l),e(".btn-delete").off().on("click",g),e("#id_conditions_num").val(t),e(".boolopstch").off("click").on("click",m),e(".profile-field").off().on("change",p),e("input[name=negated]").off().on("click",k),b(),conditions=w(),C(conditions)})}).fail(function(e){console.log("error is "+e)})}),e(".titleenrollbyprofile .add").click(function(t){e("#alert_content").empty(),e("#id_content_title").empty(),e("#id_profile_field").val("0"),e("#id_category_type").val("0"),e("#id_elements_content").empty(),e(".conditions-list").empty(),e(".rule_statement").empty(),e(".boolop").empty(),e("#id_category_type").attr("disabled","disabled")}),e(".modal-content .close ,.modal-content .close_lms_mod").click(function(t){return t.preventDefault(),e("#wait").css("display","none"),c("are you sure you want to discard changes?",function(t){return!t||(s(),e(".modal-title").text("Add A rule"),e("#enroll_by_profile_modal").modal("hide"),!0)}),!1}),e(document).on("change",".profile-field",p),e(".profile-field").on("change",p),e(".boolopstch").on("click",m),e(".add-content-link").click(function(){s(),e("#id_category_type").attr("disabled","disabled")}),T()})}}});