{"version":3,"sources":["efb_form_basic_settings.js"],"names":["define","$","document","ready","addEmail","index","email","classes","emailElement","createElement","html","attr","Math","floor","random","length","deleteEmail","append","insertBefore","children","changeToEmailTag","edit","editing","data","test","emails","indexOf","validateEditEmail","val","showEmailError","M","util","get_string","remove","join","hideEmailError","getBodyTags","string","container","each","tag","info","parent","prepend","hide","after","id","click","this","on","next","toggleClass","text","hasClass","efbEmailBodyTags","{SITE_NAME}","{USER_FULLNAME}","{USER_FIRSTNAME}","{USER_LASTNAME}","{AUTHOR_NAME}","{AUTHOR_FIRSTNAME}","{AUTHOR_LASTNAME}","{FORM_TITLE}","{USER_LINK}","{ALL_FIELDS}","{VIEW_DATA_LINK LABEL=\"click\"}","parents","siblings","{HOMEPAGE}","{DASHBOARD}","trim","show","addClass","removeClass","checkAndAdd","elem","validateEmail","nextIndex","push","split","splice","focus","changeToEmailEdit","event","keyCode","slice","preventDefault"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Edwiser Form basic settings js\n * @package   local_edwiserform\n * @copyright (c) 2020 WisdmLabs (https://wisdmlabs.com/) <support@wisdmlabs.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author    Yogesh Shirsath\n */\ndefine(['jquery'], function($) {\n    $(document).ready(function() {\n\n        /**\n         * Validate email address\n         * @param {String} email Email address\n         * @return {Integer}\n         */\n        function validateEmail(email) {\n            // eslint-disable-next-line no-useless-escape\n            var filter = /^([\\w-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([\\w-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)$/;\n            if (filter.test(email)) {\n                if (emails.indexOf(email) != -1) {\n                    return 2;\n                }\n                return 1;\n            }\n            return 0;\n\n        }\n\n        /**\n         * Validate editing email\n         * @param {Integer} index Email index\n         * @param {Email} email Email id\n         * @return {Integer}\n         */\n        function validateEditEmail(index, email) {\n            // eslint-disable-next-line no-useless-escape\n            var filter = /^([\\w-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([\\w-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)$/;\n            if (filter.test(email)) {\n                if (emails.indexOf(email) != -1 && emails.indexOf(email) != index) {\n                    return 2;\n                }\n                return 1;\n            }\n            return 0;\n\n        }\n\n        /**\n         * Add email in email list\n         * @param {Integer} index Email index\n         * @param {String}  email Email id\n         */\n        function addEmail(index, email) {\n            var classes = [\n                'primary',\n                'warning',\n                'success',\n                'info',\n            ];\n            var emailElement = document.createElement(\"span\");\n            $(emailElement).html(email);\n            $(emailElement).attr(\"data-email\", email);\n            $(emailElement).attr(\"class\", 'email-tag btn btn-' + classes[Math.floor((Math.random() * classes.length))]);\n            var deleteEmail = document.createElement(\"span\");\n            $(deleteEmail).attr(\"class\", \"email-tag-delete\");\n            $(deleteEmail).html(\"X\");\n            $(emailElement).append($(deleteEmail));\n            $(emailElement).insertBefore($(\".notifi-email-group\").children()[index]);\n        }\n\n        /**\n         * Change email tag to email edit element\n         * @param {DOM} tag Email tag element\n         */\n        function changeToEmailEdit(tag) {\n            let email = $(tag).data('email');\n            let index = $(\".email-tag\").index(tag);\n            editing = index;\n            var emailElement = document.createElement(\"input\");\n            $(tag).remove();\n            $(emailElement).val(email);\n            $(emailElement).attr(\"class\", \"notifi-email-group-edit\");\n            $(emailElement).attr(\"data-index\", index);\n            $(emailElement).insertBefore($(\".notifi-email-group\").children()[index]);\n            $(emailElement).focus();\n        }\n\n        /**\n         * Change email edit element to email tag\n         * @param {DOM} edit Email edit element\n         */\n        function changeToEmailTag(edit) {\n            if (editing != -1) {\n                var index = $(edit).data('index');\n                var status = validateEditEmail(index, $(edit).val());\n                switch (status) {\n                    case 0:\n                        showEmailError(M.util.get_string(\"efb-lbl-notifi-email-warning\", \"local_edwiserform\"));\n                        return;\n                    case 1:\n                        editing = -1;\n                        var email = $(edit).val();\n                        $(edit).remove();\n                        addEmail(index, email);\n                        emails[index] = email;\n                        $(\"#id_notifi_email\").val(emails.join(','));\n                        hideEmailError();\n                        return;\n                    case 2:\n                        showEmailError(M.util.get_string(\"efb-lbl-notifi-email-duplicate\", \"local_edwiserform\"));\n                        return;\n                }\n            }\n        }\n        $(\"#id_notifi_email\").parent().prepend('<div class=\"notifi-email-group\">' +\n        '<input type=\"email\" class=\"notifi-email-group-input form-control\" id=\"notifi-email-group-input\"/><div>' +\n        M.util.get_string('efb-recipient-email-desc', 'local_edwiserform') + '</div></div>');\n        $(\"#id_notifi_email\").hide();\n\n        // Append restore link to email body.\n        $('#id_notifi_email_body').after(M.util.get_string('efb-restore-desc', 'local_edwiserform', {\n            id: '#id_notifi_email_bodyeditable',\n            string: 'efb-notify-email-body'\n        }));\n\n        // Append restore link to confirmation message.\n        $('#id_confirmation_msg').after(M.util.get_string('efb-restore-desc', 'local_edwiserform', {\n            id: '#id_confirmation_msgeditable',\n            string: 'efb-confirmation-default-msg'\n        }));\n\n        // Append restore link to success message.\n        $('#id_success_message').after(M.util.get_string('submission-successful-desc', 'local_edwiserform', {\n            id: '#id_success_messageeditable',\n            string: 'submission-successful'\n        }));\n\n        // Restore content of editor.\n        $('.efb-restore').click(function() {\n            $($(this).data('id')).html(M.util.get_string($(this).data('string'), 'local_edwiserform'));\n        });\n\n        /**\n         * Get email body tags.\n         * @param  {String} string Lang string id\n         * @return {String}        return email body tag.\n         */\n        function getBodyTags(string) {\n            var container = \"<div class='efb-email-tags show'><ul>\";\n            $.each(string, function(tag, info) {\n                var string = M.util.get_string(info, 'local_edwiserform');\n                container += '<li><a href=\"#\" class=\"efb-email-tag\" title=\"' + string + '\">' + tag + '</a></li>';\n            });\n            container += \"</ul></div>\";\n            return container;\n        }\n        $('body').on('click', '.efb-email-show-tags>a', function() {\n            $(this).next().toggleClass('show');\n            $(this).text($(this).next().hasClass('show') ?\n            M.util.get_string('efb-email-hide-tags', 'local_edwiserform') :\n            M.util.get_string('efb-email-show-tags', 'local_edwiserform'));\n        });\n\n        var efbEmailBodyTags = {\n            \"{SITE_NAME}\": 'site-name',\n            \"{USER_FULLNAME}\": 'user-fullname',\n            \"{USER_FIRSTNAME}\": 'user-firstname',\n            \"{USER_LASTNAME}\": 'user-lastname',\n            \"{AUTHOR_NAME}\": 'author-name',\n            \"{AUTHOR_FIRSTNAME}\": 'author-firstname',\n            \"{AUTHOR_LASTNAME}\": 'author-lastname',\n            \"{FORM_TITLE}\": 'form-title',\n            \"{USER_LINK}\": 'user-link',\n            \"{ALL_FIELDS}\": 'all-fields',\n            \"{VIEW_DATA_LINK LABEL=\\\"click\\\"}\": 'view-data-link',\n        };\n        var successMessageTags = {\n            \"{HOMEPAGE}\": 'homepage',\n            \"{DASHBOARD}\": 'dashboard',\n            \"{VIEW_DATA_LINK LABEL=\\\"click\\\"}\": 'view-data-link',\n        };\n        // Email tags for email body.\n        $(\"#id_notifi_email_body\").parents('.felement').siblings().\n        append('<div class=\"efb-email-show-tags\"><a href=\"#\">' +\n        M.util.get_string('efb-email-hide-tags', 'local_edwiserform') + '</a>' + getBodyTags(efbEmailBodyTags) + '</div>');\n\n        // Email tags for confirmation message.\n        $(\"#id_confirmation_msg\").parents('.felement').siblings().\n        append('<div class=\"efb-email-show-tags\"><a href=\"#\">' +\n        M.util.get_string('efb-email-hide-tags', 'local_edwiserform') + '</a>' + getBodyTags(efbEmailBodyTags) + '</div>');\n\n        // Tags for success message.\n        $(\"#id_success_message\").parents('.felement').siblings().\n        append('<div class=\"efb-email-show-tags\"><a href=\"#\">' +\n        M.util.get_string('efb-email-hide-tags', 'local_edwiserform') + '</a>' + getBodyTags(successMessageTags) + '</div>');\n\n        var emails = $(\"#id_notifi_email\").val().trim();\n        var editing = -1;\n        if (emails.length > 0) {\n            emails = emails.split(\",\");\n        } else {\n            emails = [];\n        }\n        $.each(emails, function(index, email) {\n            addEmail(index, email);\n        });\n\n        $(\"body\").on(\"click\", \".email-tag-delete\", function() {\n            var email = $(this).parent();\n            var index = $(\".email-tag\").index(email);\n            emails.splice(index, 1);\n            email.remove();\n            $(\"#id_notifi_email\").val(emails.join(','));\n        });\n\n        $(\"body\").on(\"dblclick\", \".email-tag\", function() {\n            changeToEmailEdit($(this));\n        });\n\n        $(\"body\").on(\"focusout\", \".notifi-email-group-edit\", function() {\n            changeToEmailTag($(this));\n        });\n\n        $(\"body\").on(\"keyup\", \".notifi-email-group-edit\", function(event) {\n            if (event.keyCode == 13 || event.keyCode == 27) {\n                changeToEmailTag($(this));\n            }\n        });\n\n        /**\n         * Show email validation error.\n         * @param {String} string Error string\n         */\n        function showEmailError(string) {\n            $(\"#id_error_notifi_email\").html(string);\n            $(\"#id_error_notifi_email\").show();\n            $(\"#id_error_notifi_email\").parent(\".felement\").addClass('has-danger');\n        }\n\n        /**\n         * Hide email validation error.\n         */\n        function hideEmailError() {\n            $(\"#id_error_notifi_email\").hide().parent(\".felement\").removeClass('has-danger');\n            $(\"#id_notifi_email\").val(emails.join(','));\n        }\n\n        /**\n         * Check and add email in the list.\n         * @param {DOM} elem Email input element\n         */\n        function checkAndAdd(elem) {\n            if ($(elem).val() == '') {\n                hideEmailError();\n                return;\n            }\n            var status = validateEmail($(elem).val());\n            switch (status) {\n                case 0:\n                    showEmailError(M.util.get_string(\"efb-lbl-notifi-email-warning\", \"local_edwiserform\"));\n                    return;\n                case 1:\n                    var nextIndex = $(elem).siblings('.email-tag').length;\n                    var email = $(elem).val().trim();\n                    addEmail(nextIndex, email);\n                    emails.push(email);\n                    $(elem).val('');\n                    hideEmailError();\n                    return;\n                case 2:\n                    showEmailError(M.util.get_string(\"efb-lbl-notifi-email-duplicate\", \"local_edwiserform\"));\n                    return;\n            }\n        }\n\n        $(\"body\").on(\"keyup\", \"#notifi-email-group-input\", function(event) {\n            if (event.keyCode == 13 || event.keyCode == 32) { // Enter key or space key.\n                checkAndAdd(this);\n            } else if (event.keyCode == 188) { // Comma key.\n                $(this).val($(this).val().slice(0, -1));\n                checkAndAdd(this);\n            }\n        });\n\n        $(\"body\").on(\"focusout\", \"#notifi-email-group-input\", function(event) {\n            event.preventDefault();\n            checkAndAdd(this);\n        });\n    });\n});\n"],"file":"efb_form_basic_settings.min.js"}