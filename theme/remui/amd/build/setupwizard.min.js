/**
 * TODO describe module setupwizard
 *
 * @module     theme_remui/setupwizard
 * @copyright  2024 YOUR NAME <your@email.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_remui/setupwizard",["jquery","core/templates","core/ajax","core/notification","core/str","theme_remui/feedbackcollection"],(function($,Templates,Ajax,Notification,Str,feedbackcollection){const SELECTORS_SETUPMAIN_WRAPPER="#setupmain-wrapper",SELECTORS_NEXT_PAGE=".setup-navigation .next-page",SELECTORS_SETUP_ERROR=".setupwizard-error-msg",SELECTORS_SETUP_SUCCESS=".setupwizard-success-msg",SELECTORS_CHECKING_HEADING=".check-requirements .checking",SELECTORS_CONTINUESETUPBTN=".continuesetup-btn",SELECTORS_SETUPWIZARD_MODAL=".setupwizard-modal",SELECTORS_LICENSEKEYINPUT="#licensekey-input",SELECTORS_LICENSESUBMITBTN=".license-submit-btn",SELECTORS_LICENSEACKMSG=".license-ack-msg",SELECTORS_USERINFORMATION_FORM="#user-information-form",SELECTORS_USERINFORMATION_SUBMIT_BTN='#user-information-form .btn[type="submit"]',SELECTORS_INSTALLABLE_PLUGINS_WRAPPER=".installable-plugins-wrapper",SELECTORS_RESUMESETUPBTN="#resume-setup",SELECTORS_RETRYYOURSETUPBTN=".sitesetup-retry .btn",SELECTORS_SITESETUP_FEEDBACK="#setupmain-wrapper .sitesetup-feedback",SELECTORS_ACTIVATEREMUIBTN="#activate-remui-btn",SELECTORS_CLOSECURRENTWINDOW=".close-current-window",SELECTORS_SITESETUPLOADER=".sitesetup-loader-container",SELECTORS_SKIPSERVERCHECKBTN=".skip-server-check",STEPSNAME_SERVER_CHECK="servercheck",STEPSNAME_USER_INFORMATION="userinformation",STEPSNAME_LICENSE_ACTIVATION="licenseactivation",STEPSNAME_SITESETUP="sitesetup",STEPSNAME_FINAL="final",STEPSNAME_FINISHED="finished";let setupwizardContext=null,installationQueue=[],installedPluginList=[];const pluginProgressStatusTemplate="theme_remui/setupwizard/setup_plugin_progress_status";let allPluginInstallSuccess=!0,modalInitialized=!1,progressInterval=null;const strings=[{key:"checkingdone",component:"theme_remui"},{key:"downloadsuccessmsg",component:"theme_remui"},{key:"installsuccessmsg",component:"theme_remui"},{key:"setratingreviewoncourse",component:"theme_remui"},{key:"courseformatsetmsg",component:"theme_remui"},{key:"setashomepage",component:"theme_remui"},{key:"enablesuccessmsg",component:"theme_remui"},{key:"ratingreviewaddedallcoursesmsg",component:"theme_remui"},{key:"otherpagenotice",component:"theme_remui"},{key:"downloadfailed",component:"theme_remui"},{key:"tryagain",component:"theme_remui"},{key:"somthingwentwrong",component:"theme_remui"}];var LANGS;const fetchLanguages=()=>{Str.get_strings(strings).then((function(results){return LANGS=results,results}))},get_setupwizard_context=async()=>new Promise((resolve=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"get_setupwizard_context",config:JSON.stringify({})},done:function(response){setupwizardContext=JSON.parse(response),resolve(setupwizardContext)},fail:function(ex){Notification.exception(ex),resolve(null)}}])}));function append_template(parentSelector,template,context){return Templates.render(template,{config:M.cfg,...context}).done((function(html,js){Templates.appendNodeContents($(parentSelector),html,js)}))}function handle_add_retry_button(){append_template(SELECTORS_SETUPMAIN_WRAPPER+" .sitesetup-retry",pluginProgressStatusTemplate,{setupbtn:!0,btnclass:"install-try-again btn btn-primary ml-auto",text:LANGS[10]}),installationQueue=[],installedPluginList=[]}function set_setup_status(step){return Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"set_setup_status",config:JSON.stringify({status:step})}}])[0]}function install_exception_error(plugin,ex){append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{exception:!0,id:plugin+"-exception",message:"something went wrong",exceptionmsg:ex.stack||ex.message||ex||"Unknown error occurred"}),$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress").remove()}function set_ratingreview_to_allcourses(){let setupbtn=$(this);setupbtn.addClass("loading"),setTimeout((()=>{Ajax.call([{methodname:"block_edwiserratingreview_add_plugin_to_course",args:{userdeniedvalue:"true"},done:function(){setupbtn.remove(),append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #block_edwiserratingreview .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[7]})},fail:function(ex){console.log(ex)}}])}),500)}function plugins_setup_after_installation($data){return new Promise((resolve=>{installedPluginList.forEach((async plugin=>{"block_edwiserratingreview"===plugin&&(Number(setupwizardContext.isratingreviewaddedtocourses)?append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[7]}):append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{setupbtn:!0,btnclass:"set-edwiserratingreview btn btn-secondary btn-sm",text:LANGS[3]})),"format_remuiformat"===plugin&&await function(plugin){return new Promise((resolve=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"set_default_course_format",config:JSON.stringify({})},done:function(response){append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[4]}),resolve(JSON.parse(response))},fail:function(ex){Notification.exception(ex),resolve(null)}}])}))}(plugin),"local_edwiserpagebuilder"===plugin&&await function(plugin){return new Promise((resolve=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"set_pagebuilder_for_homepage",config:JSON.stringify({})},done:function(response){append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[5]}),resolve(JSON.parse(response))},fail:function(ex){Notification.exception(ex),resolve(null)}}])}))}(plugin),"filter_edwiserpbf"===plugin&&await function(plugin){return new Promise((resolve=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"enable_filterplugin",config:JSON.stringify({})},done:function(response){append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[6]}),resolve(JSON.parse(response))},fail:function(ex){Notification.exception(ex),resolve(null)}}])}))}(plugin),$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress").remove()})),resolve(null)}))}function remove_downloaded_zip_and_purge_cache(){let purgecache=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"remove_downloaded_zip_and_purge_cache",config:JSON.stringify({purgecache:purgecache})}}])[0]}function downloadPlugins(){let retryCount=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return new Promise(((resolve,reject)=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"plugin_download_handler",config:JSON.stringify({plugins:setupwizardContext.pluginslist})},done:function(updateResponse){resolve(updateResponse)},fail:function(ex){"upgraderunning"===ex.errorcode&&retryCount<6||retryCount<4?setTimeout((()=>{downloadPlugins(retryCount+1).then(resolve).catch(reject)}),36e4*retryCount):resolve([])}}])}))}function save_newplugin_settings(){let retryCount=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(((resolve,reject)=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"save_newplugin_settings",config:JSON.stringify({})},done:function(updateResponse){resolve("true")},fail:function(ex){"upgraderunning"===ex.errorcode&&retryCount<30?setTimeout((()=>{save_newplugin_settings(retryCount+1).then(resolve).catch(reject)}),6e4):retryCount<2?save_newplugin_settings(retryCount+1).then(resolve).catch(reject):resolve(null)}}])}))}async function updateDatabase(plugin){let retryCount=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Promise(((resolve,reject)=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"plugin_database_upgrader_handler",config:JSON.stringify({})},done:function(updateResponse){const updateData=JSON.parse(updateResponse);append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[2]});parseInt($(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress .inprogress-value").text())<45&&$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress .inprogress-value").text(generateRandomNumber(45,55)),installedPluginList.push(plugin),resolve(updateData)},fail:function(ex){"upgraderunning"===ex.errorcode&&retryCount<30?setTimeout((()=>{updateDatabase(plugin,retryCount+1).then(resolve).catch(reject)}),6e4):retryCount<3?setTimeout((()=>{updateDatabase(plugin,retryCount+1).then(resolve).catch(reject)}),3e4):install_exception_error(plugin,ex)},timeout:36e5}])}))}function handlePluginInstallation(plugin,url){return epb_blocks_setup_info_handler(plugin),new Promise(((resolve,reject)=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"plugin_install_handler",config:JSON.stringify({zipfile:url})},done:async function(installResponse){const response=JSON.parse(installResponse);if(response.success?(await updateDatabase(plugin),epb_blocks_setup_info_handler(plugin,!0)):(response.error||response.info)&&append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{error:response.error,info:response.info,message:response.message}),response.error&&($(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress").remove(),epb_blocks_setup_info_handler(plugin,!0)),response.info){parseInt($(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress .inprogress-value").text())<45&&$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress .inprogress-value").text(generateRandomNumber(45,55)),installedPluginList.push(plugin),epb_blocks_setup_info_handler(plugin,!0)}resolve(response)},fail:function(ex){install_exception_error(plugin,ex),resolve(null)}}])}))}function queueInstallation(plugin,url){return new Promise((resolve=>{installationQueue.push((()=>handlePluginInstallation(plugin,url).then(resolve))),1===installationQueue.length&&async function(){for(;installationQueue.length>0;)await installationQueue[0](),installationQueue.shift()}()}))}function generateRandomNumber(){let min=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,max=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return Math.floor(Math.random()*(max-min+1))+min}function installation_progress_value_handler(){let min=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;progressInterval&&clearInterval(progressInterval);const progressValues=$(".inprogress .inprogress-value");function updateProgressValues(){progressValues.each((function(){const progressValue=parseInt($(this).text());if(progressValue&&progressValue<85){let nextValue=min?Math.max(min,progressValue):progressValue;$(this).text(generateRandomNumber(nextValue,nextValue+5))}else progressValue||($(this).text(generateRandomNumber(1,5)),$(this).siblings(".percentage-icon").removeClass("d-none"))}))}progressValues.length>0&&(setTimeout(updateProgressValues,2e3),progressInterval=setInterval(updateProgressValues,15e3))}function epb_blocks_setup_info_handler(plugin){let shouldremove=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const epb_blocks_setup_info=$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" ."+plugin+"_setup-info");console.log({epb_blocks_setup_info:epb_blocks_setup_info}),epb_blocks_setup_info.length&&(shouldremove?epb_blocks_setup_info.addClass("d-none"):epb_blocks_setup_info.removeClass("d-none"))}async function sitesetuphandler(){try{await remove_downloaded_zip_and_purge_cache(!1);const response=await downloadPlugins(),data=JSON.parse(response);if(Object.entries(data).length)for(const[plugin,url]of Object.entries(setupwizardContext.pluginslist))plugin in data?await append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{success:!0,message:LANGS[1]}):(await append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .installation-status",pluginProgressStatusTemplate,{error:!0,message:LANGS[9]}),$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" #"+plugin+" .inprogress").remove(),allPluginInstallSuccess=!1);if(0===Object.entries(data).length||0===Object.entries(setupwizardContext.pluginslist).length)$(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER).empty(),await append_template(SELECTORS_INSTALLABLE_PLUGINS_WRAPPER,pluginProgressStatusTemplate,{error:!0,message:LANGS[11]}),handle_add_retry_button();else{installation_progress_value_handler(25);for(const[plugin,url]of Object.entries(data))await queueInstallation(plugin,url);await save_newplugin_settings();await plugins_setup_after_installation(),$(SELECTORS_SITESETUPLOADER).removeClass("d-none").addClass("d-flex"),progressInterval&&clearInterval(progressInterval),Object.keys(setupwizardContext.pluginslist).length===installedPluginList.length&&allPluginInstallSuccess?(await new Promise((function(resolve,reject){Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"basic_theme_setup",config:JSON.stringify({})},done:async function(response){var data=JSON.parse(response),templatecontext=[];templatecontext.homepage=[],templatecontext.otherpage=[];var notices=[];notices.homepage=!1,notices.otherpage=!1,$(".site-setup-elem-wraper").removeClass("d-none");for(const[key,value]of Object.entries(data.pluginsetup))setTimeout((()=>{$(SELECTORS_SITESETUPLOADER).removeClass("d-flex").addClass("d-none"),$(".site-setup-elem-wraper").append(value)}),1500);setTimeout((async()=>{if(data.edwiserpagebuilderexist){var pageinfo=await async function($config){const request={methodname:"theme_remui_do_setup_action",args:{action:"get_layout_info",config:JSON.stringify($config)}};return Ajax.call([request])[0]}(setupwizardContext.layouts);pageinfo=JSON.parse(pageinfo);for(const[key,value]of Object.entries(pageinfo))if("homepage"==key)await set_home_page(value.layout),templatecontext.homepage.push(value);else{var pagedraftid=await set_custom_pages(value);if(pagedraftid=JSON.parse(pagedraftid)){var pageid=await publish_custom_pages(pagedraftid),pageurl=M.cfg.wwwroot+"/local/edwiserpagebuilder/page.php?id="+JSON.parse(pageid);pageinfo[key].publishedpage=pageurl}templatecontext.otherpage.push(pageinfo[key]),notices.otherpage=LANGS[8]}await async function(templatecontext){const request={methodname:"theme_remui_do_setup_action",args:{action:"set_pagelinks_in_footer",config:JSON.stringify(templatecontext)}};return Ajax.call([request])[0]}(templatecontext.otherpage);for(const[key,value]of Object.entries(templatecontext)){let template="theme_remui/setupwizard/page_course_card",parentSelector=".configuration-wrapper."+key+"setup .content";$(parentSelector).empty();var context=[];context.pagecards=value,context.notice=notices[key],await append_template(parentSelector,template,context)}}else $(".configuration-wrapper.homepagesetup").remove(),$(".configuration-wrapper.otherpagesetup").remove();data.edwisersiteimporterexist,resolve(null)}),2e3)},fail:function(ex){Notification.exception(ex),resolve(null)}}])})),$(SELECTORS_SETUPMAIN_WRAPPER+" .setup-navigation").removeClass("d-none").addClass("d-flex")):($(SELECTORS_SITESETUPLOADER).removeClass("d-flex").addClass("d-none"),handle_add_retry_button())}}catch(ex){Notification.exception(ex)}}async function submitUserInformation(e){e.preventDefault();let formData=[];const checkedInputs=$(SELECTORS_USERINFORMATION_FORM+' input[type="radio"]:checked');for(const input of checkedInputs){const name=$(input).attr("name"),question=$('.info-question[data-questionfor="'+name+'"]').data("value");let ans=$(input).val();formData.push({question:question,answer:ans})}Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"save_setup_info",config:JSON.stringify({usersiteinfo:formData})},done:function(response){response=JSON.parse(response)},fail:function(ex){Notification.exception(ex)}}]),await async function(formData){return Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"send_usersiteinfo_to_edwiser",config:JSON.stringify({usersiteinfo:formData})}}])[0]}(formData);nextPageHandler("",$(SELECTORS_USERINFORMATION_SUBMIT_BTN).data("nextstep"))}function checkAllQuestionsAnswered(){const totalQuestions=$(SELECTORS_USERINFORMATION_FORM).find(".info-question").length;$(SELECTORS_USERINFORMATION_FORM).find('input[type="radio"]:checked').length===totalQuestions?$(SELECTORS_USERINFORMATION_SUBMIT_BTN).removeClass("disabled"):$(SELECTORS_USERINFORMATION_SUBMIT_BTN).hasClass("disabled")||$(SELECTORS_USERINFORMATION_SUBMIT_BTN).addClass("disabled")}function checkCustomAnswerInput(){let textInput=$(this),targetQuestionId="#"+$(this).data("inputfor"),targetQuestion=$(SELECTORS_USERINFORMATION_FORM+' input[type="radio"]'+targetQuestionId);textInput.val().length>0?(targetQuestion.prop("checked",!0),targetQuestion.val(textInput.val())):targetQuestion.prop("checked",!1),checkAllQuestionsAnswered()}async function setup_licenseactivation(){let template="theme_remui/setupwizard/setup_"+STEPSNAME_LICENSE_ACTIVATION;await save_newplugin_settings(),$(SELECTORS_SETUPMAIN_WRAPPER).empty(),append_template(SELECTORS_SETUPMAIN_WRAPPER,template,setupwizardContext).then((()=>{setupwizardContext.licensekey&&licenseActivationHandler(setupwizardContext.licensekey),sessionStorage.setItem("setup_step",STEPSNAME_LICENSE_ACTIVATION)}))}async function setup_sitesetup(){var _plugincontext,_plugincontext2;let template="theme_remui/setupwizard/setup_"+STEPSNAME_SITESETUP;$(SELECTORS_SETUPMAIN_WRAPPER).empty();let plugincontext=await Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"get_installableplugin_list",config:JSON.stringify({})}}])[0];plugincontext=JSON.parse(plugincontext),setupwizardContext.pluginslist=(null===(_plugincontext=plugincontext)||void 0===_plugincontext?void 0:_plugincontext.pluginslist)||[],setupwizardContext.structuredpluginlist=null===(_plugincontext2=plugincontext)||void 0===_plugincontext2?void 0:_plugincontext2.structuredpluginlist,append_template(SELECTORS_SETUPMAIN_WRAPPER,template,setupwizardContext).then((()=>{sessionStorage.setItem("setup_step",STEPSNAME_SITESETUP),installation_progress_value_handler(),sitesetuphandler()}))}function setup_sitesetup_feedback(e){feedbackcollection.submit_feedback_handler(e),set_setup_status(STEPSNAME_FINISHED),window.location=M.cfg.wwwroot}function add_activateremui_step(e){$(SELECTORS_SETUPMAIN_WRAPPER+" .setup-container.loading-container").remove(),$(SELECTORS_SETUPMAIN_WRAPPER+" .setup-container").removeClass("d-none")}function current_step_handler(nextstep){switch(nextstep){case STEPSNAME_SERVER_CHECK:!function(){let template="theme_remui/setupwizard/setup_"+STEPSNAME_SERVER_CHECK;$(SELECTORS_SETUPMAIN_WRAPPER).empty(),append_template(SELECTORS_SETUPMAIN_WRAPPER,template,setupwizardContext).then((()=>{sessionStorage.setItem("setup_step",STEPSNAME_SERVER_CHECK),setTimeout((()=>{Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"system_server_check",config:JSON.stringify({})},done:function(response){response=JSON.parse(response),$(SELECTORS_CHECKING_HEADING).text(LANGS[0]),Object.entries(response.requirechecks).forEach((_ref=>{let[key,value]=_ref;$("."+key+" .loader").addClass("d-none"),value?$("."+key+" "+SELECTORS_SETUP_SUCCESS).removeClass("d-none").addClass("d-flex"):("writeaccesscheck"==key&&$("."+key+" "+SELECTORS_SETUP_ERROR+" span").text(response.nonwriteablepluginsmsg),$("."+key+" "+SELECTORS_SETUP_ERROR).removeClass("d-none").addClass("d-flex"))})),response.allchecks&&$(SELECTORS_NEXT_PAGE).removeClass("disabled")},fail:function(ex){Notification.exception(ex)}}])}),800)}))}();break;case STEPSNAME_USER_INFORMATION:!function(){let template="theme_remui/setupwizard/setup_"+STEPSNAME_USER_INFORMATION;$(SELECTORS_SETUPMAIN_WRAPPER).empty(),append_template(SELECTORS_SETUPMAIN_WRAPPER,template,setupwizardContext).then((()=>{sessionStorage.setItem("setup_step",STEPSNAME_USER_INFORMATION)}))}();break;case STEPSNAME_LICENSE_ACTIVATION:setup_licenseactivation();break;case STEPSNAME_SITESETUP:setup_sitesetup();break;case STEPSNAME_FINAL:!function(){let template="theme_remui/setupwizard/setup_"+STEPSNAME_FINAL;$(SELECTORS_SETUPMAIN_WRAPPER).empty(),append_template(SELECTORS_SETUPMAIN_WRAPPER,template,setupwizardContext).then((async()=>{sessionStorage.setItem("setup_step",STEPSNAME_FINAL),await remove_downloaded_zip_and_purge_cache()}))}();break;default:setup_licenseactivation()}}function nextPageHandler(e){let nextstep=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";nextstep||(nextstep=$(this).data("nextstep")),set_setup_status(nextstep),current_step_handler(nextstep)}function initializeWizard(){let currentstep=sessionStorage.getItem("setup_step");setupwizardContext.resumestep===STEPSNAME_FINAL||setupwizardContext.resumestep===STEPSNAME_FINISHED?current_step_handler(STEPSNAME_FINAL):!currentstep&&setupwizardContext.resumestep?setupwizardContext.resumestep===STEPSNAME_SITESETUP?current_step_handler(STEPSNAME_SERVER_CHECK):current_step_handler(setupwizardContext.resumestep):current_step_handler(currentstep)}function licenseActivationHandler($licensekey){let action=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"check";Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"license_check",config:JSON.stringify({licensekey:$licensekey,operation:action})},done:function(response){response=JSON.parse(response);var textinfoclass="sucessinfo";$(SELECTORS_LICENSEKEYINPUT)&&($(SELECTORS_LICENSESUBMITBTN).removeClass("disabled"),$(SELECTORS_LICENSEKEYINPUT).removeClass("is-checking")),"Active"==response.licensestatus?($(SELECTORS_LICENSEKEYINPUT).addClass("is-valid").removeClass("is-invalid"),$(SELECTORS_LICENSESUBMITBTN).addClass("d-none"),$(SELECTORS_NEXT_PAGE).removeClass("d-none")):($(SELECTORS_LICENSEKEYINPUT).addClass("is-invalid").removeClass("is-valid"),textinfoclass="failureinfo"),response.alert?$(SELECTORS_LICENSEACKMSG).removeClass("d-none").removeClass("sucessinfo failureinfo").addClass(textinfoclass).html(response.alert.text):"Active"==response.licensestatus?$(SELECTORS_LICENSEACKMSG).removeClass("d-none").removeClass("failureinfo").addClass("sucessinfo").text(response.licensestatus):$(SELECTORS_LICENSEACKMSG).removeClass("d-none").removeClass("failureinfo").addClass("failureinfo").text(response.licensestatus)},fail:function(ex){Notification.exception(ex)}}])}async function set_home_page(blocklayout){const request={methodname:"local_edwiserpagebuilder_add_adv_block_layout",args:{layout:blocklayout,pagetype:"site-index",region:"full-width-top",subpagetypepattern:null,courseid:M.cfg.courseId,contextinstanceid:M.cfg.contextInstanceId}};return Ajax.call([request])[0]}async function set_custom_pages(config){const request={methodname:"local_edwiserpagebuilder_do_page_action",args:{action:"add_new_page_with_layoutid",config:JSON.stringify(config)}};return Ajax.call([request])[0]}async function publish_custom_pages(id){const request={methodname:"local_edwiserpagebuilder_do_page_action",args:{action:"publish_page_with_layouts",config:JSON.stringify({id:id})}};return Ajax.call([request])[0]}function close_current_window(){window.close()}function activate_remui(){Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"set_theme",config:JSON.stringify({})},done:function(response){"success"==(response=JSON.parse(response))&&window.location.reload()},fail:function(ex){Notification.exception(ex)}}])}function initSetupModal(){if(modalInitialized)return;let isremui="remui"===M.cfg.theme;return $(".setupwizard-modal").length>0&&$(".setupwizard-modal").remove(),modalInitialized=!0,Templates.render("theme_remui/setupwizard/setupwizard_modal",{config:M.cfg,isremui:isremui}).done((function(html,js){Templates.appendNodeContents($("body"),html,js)}))}const registerCommonEvents=showmodal=>{showmodal&&initSetupModal(),$(document).on("click",SELECTORS_NEXT_PAGE,nextPageHandler),$(document).off("click",SELECTORS_CONTINUESETUPBTN).on("click",SELECTORS_CONTINUESETUPBTN,(function(){$(SELECTORS_SETUPWIZARD_MODAL).modal("hide");feedbackcollection.submit_feedback("setupmodal_continuesetupbtnstate_info",{question:"User clicked on  the continue setup button",answer:"Yes"}),Ajax.call([{methodname:"theme_remui_do_setup_action",args:{action:"set_theme",config:JSON.stringify({})},done:function(response){if("success"==(response=JSON.parse(response))){$("body .setupwizard-modal").hide(),$("body .modal-backdrop").hide(),$("body .setupwizard-modal").remove();var url=M.cfg.wwwroot+"/theme/remui/setup.php";window.open(url,"_blank")}},fail:function(ex){Notification.exception(ex)}}])})),$(document).on("click",SELECTORS_SETUPWIZARD_MODAL+" .btn-close",(function(){$(SELECTORS_SETUPWIZARD_MODAL).modal("hide");feedbackcollection.submit_feedback("setupmodal_close_info",{question:"User closed the setup wizard modal",answer:"Yes"}),function(){const request={methodname:"theme_remui_do_setup_action",args:{action:"skipsetup_from_modal",config:JSON.stringify({})}};Ajax.call([request])[0]}()})),$(document).on("click","#remui-setup-checkbox",(function(){$(this).is(":checked")?$(SELECTORS_CONTINUESETUPBTN).removeClass("disabled"):$(SELECTORS_CONTINUESETUPBTN).addClass("disabled")})),$(document).on("keyup",SELECTORS_LICENSEKEYINPUT,(function(){$(this).val().length>0?$(SELECTORS_LICENSESUBMITBTN).removeClass("disabled"):$(SELECTORS_LICENSESUBMITBTN).addClass("disabled")})),$(document).on("click",SELECTORS_LICENSESUBMITBTN,(function(){$(this).addClass("disabled"),$(SELECTORS_LICENSEKEYINPUT).addClass("is-checking"),licenseActivationHandler($(SELECTORS_LICENSEKEYINPUT).val(),"activate")})),$(document).on("click",SELECTORS_RESUMESETUPBTN,(function(e){e.preventDefault();if(feedbackcollection.submit_feedback("resume_setup_wizard",{question:"User clicked on the resume setup button",answer:"Yes"}),""==$(this).attr("data-action"))initSetupModal();else{var pageurl=$(this).attr("href");window.open(pageurl,"_blank")}})),$(document).on("click",SELECTORS_SKIPSERVERCHECKBTN,(function(e){feedbackcollection.submit_feedback("skip_server_check_info",{question:"User skipped the server permission check step",answer:"Yes"}),window.location=M.cfg.wwwroot+"/my/"}))};return{init:function(){let isremui=arguments.length>0&&void 0!==arguments[0]&&arguments[0];$(document).ready((async function(){await get_setupwizard_context(),fetchLanguages(),isremui?initializeWizard():add_activateremui_step(),registerCommonEvents(!1),$(document).off("submit",SELECTORS_USERINFORMATION_FORM).on("submit",SELECTORS_USERINFORMATION_FORM,submitUserInformation),$(document).on("change",SELECTORS_USERINFORMATION_FORM+' input[type="radio"]',checkAllQuestionsAnswered),$(document).on("input focus",SELECTORS_USERINFORMATION_FORM+' input[type="text"]',checkCustomAnswerInput),$(document).on("click",SELECTORS_INSTALLABLE_PLUGINS_WRAPPER+" .set-edwiserratingreview",set_ratingreview_to_allcourses),$(document).on("click",SELECTORS_RETRYYOURSETUPBTN,(()=>window.location.reload())),$(document).on("submit",SELECTORS_SITESETUP_FEEDBACK,setup_sitesetup_feedback),$(document).on("click",SELECTORS_ACTIVATEREMUIBTN,activate_remui),$(document).on("click",SELECTORS_CLOSECURRENTWINDOW,close_current_window),window.addEventListener("beforeunload",(function(e){if($(".installable-plugins-wrapper").lenght>0)return e.preventDefault(),""}))}))},registerModalEvents:function(showmodal){$(document).ready((async function(){registerCommonEvents(showmodal)}))}}}));

//# sourceMappingURL=setupwizard.min.js.map