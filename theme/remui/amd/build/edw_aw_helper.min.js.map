{"version":3,"file":"edw_aw_helper.min.js","sources":["../src/edw_aw_helper.js"],"sourcesContent":["/* eslint-disable no-undef */\n/* eslint-disable no-unused-vars */\n/* eslint-disable no-console */\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable no-restricted-globals */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     theme_remui/edw_aw_helper\n * @copyright (c) 2020 WisdmLabs (https://wisdmlabs.com/)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/str', 'core/toast', 'theme_remui/feedbackcollection','core_user/repository'], function ($, Ajax, Str, Toast, feedbackcollection,UserRepository) {\n\n    /**\n     * Selectors\n     */\n    var SELECTOR = {\n        ENABLEAW: 'a[href=\"#enable_aw\"]',\n        DISABLEAW: 'a[href=\"#disable_aw\"]',\n        ASWMENUBTN: '.asw-menu-btn',\n        ASWMENUSETTING: '.asw-menu-setting',\n        ASWMENUSETTINGDROPDOWNBTN: '#aw_settingsDropdown',\n        ADMINSETTINGURL: '.adminsettingurl',\n        PREFSETTINGURL: '.prefsettingurl',\n        ASWCONTAINER: '.asw-container',\n    };\n\n    const registerCommonEvents = (issiteadmin, feedbackstatus, isloggedin) => {\n\n        $(document).on(\"click\", SELECTOR.ENABLEAW + \",\" + SELECTOR.DISABLEAW, function (e) {\n            e.preventDefault(); // Prevent default anchor behavior\n\n            var $this = $(this); // Store reference to clicked element\n            let message = '';\n\n            if ($this.attr(\"href\") == \"#enable_aw\") {\n                const newState = {\n                    href: \"#disable_aw\",\n                    string: 'enable-aw-for-me',\n                    value: false\n                };\n                updateAWState($this, newState);\n                message = M.util.get_string('enable-aw-for-me-notice', 'theme_remui');\n            } else {\n                const newState = {\n                    href: \"#enable_aw\",\n                    string: 'disable-aw-for-me',\n                    value: true\n                };\n                updateAWState($this, newState);\n                message = M.util.get_string('disable-aw-for-me-notice', 'theme_remui');\n            }\n            // Store the notification message in localStorage\n            localStorage.setItem(\"awNotification\", message);\n            // Reload the page\n            setTimeout(() => {\n                window.location.reload();\n            }, 200);\n        });\n\n        $(document).on(\"click\", `${SELECTOR.ASWCONTAINER},${SELECTOR.ASWMENUSETTINGDROPDOWNBTN}`, function (e) {\n\n            var siteadminurl = M.cfg.wwwroot + \"/admin/settings.php?section=themesettingremui#admin-enableaccessibilitytools\";\n            var prefurl = M.cfg.wwwroot + \"/user/preferences.php\";\n\n            // Update the href attributes\n            $(SELECTOR.ADMINSETTINGURL).attr('href', siteadminurl);\n            $(SELECTOR.PREFSETTINGURL).attr('href', prefurl);\n\n            // Show/hide admin settings based on issiteadmin\n            if (issiteadmin) {\n                $(SELECTOR.ADMINSETTINGURL).show();\n            } else {\n                $(SELECTOR.ADMINSETTINGURL).hide();\n            }\n\n            if (!feedbackstatus) {\n                setTimeout(() => {\n                    $(\".asw-footer\").removeClass('d-none');\n                }, 3000);\n            }\n        });\n\n        $(document).on(\"click\", '#aw_feedbackcollection-form .aw-feedback-close', async function(e) {\n            removeFeedbackOption();\n        });\n\n        $(document).on(\"change\", '#aw_feedbackcollection-form .feedback-item input[type=\"radio\"]', async function() {\n            var question = $('#aw_feedbackcollection-form input[name=\"question\"]').val();\n            var questionName = $('#aw_feedbackcollection-form input[name=\"questionname\"]').val();\n            var answer = $('#aw_feedbackcollection-form input[name=\"answer\"]:checked').val();\n\n            // Create form data object\n            var submitData = {\n                question: question,\n                answer: answer,\n                usercomment: \"\"\n            };\n\n            removeFeedbackOption(true);\n\n            feedbackHandler(questionName, submitData);\n        });\n\n        $(document).on(\"submit\", '#aw_feedbackcollection-form', async function(e) {\n            e.preventDefault();\n            // Get form data using FormData\n            const formData = new FormData(this);\n\n            // Access individual values\n            const question = formData.get('question');\n            const questionName = formData.get('questionname');\n            const answer = $('#aw_feedbackcollection-form input[name=\"answer\"]:checked').val();\n\n            const submitType = $(e.target).find('button[type=\"submit\"]:focus').data('type');\n            const feedback = submitType === \"submit\" ? formData.get('feedback') : \"\";\n\n            // Create form data object\n            var submitData = {\n                question: question,\n                answer: answer,\n                usercomment: feedback,\n            };\n\n            feedbackHandler(questionName, submitData, true);\n        });\n    };\n    function update_aw_feedback(submiteddata, isgetfeedback = false) {\n        return Ajax.call([{\n            methodname: 'theme_remui_do_feedbackcollection_action',\n            args: {\n                action: \"update_aw_feedback\",\n                config: JSON.stringify({\n                    \"feedback\": submiteddata,\n                    \"isgetfeedback\": isgetfeedback\n                })\n            }\n        }])[0];\n    }\n    // Helper function to update the AW state\n    function updateAWState($element, state) {\n        $element.attr(\"href\", state.href).text(M.util.get_string(state.string, 'theme_remui'));\n            require(['core_user/repository'], function(UserRepository) {\n                UserRepository.setUserPreference('acs-widget-status', state.value);\n            });\n    }\n\n    function removeFeedbackOption(onlyHide = false) {\n        if (onlyHide) {\n\n            $(\".asw-footer\").css(\"padding\", 0);\n            $(\".feedback-question-wrapper\").removeClass(\"d-flex\").addClass(\"d-none\");\n\n            return;\n        }\n\n        var feedback_option = $(\".asw-footer\");\n        feedback_option.remove();\n    }\n\n    async function feedbackHandler(questionName, submitData, isgetfeedback = false) {\n        var aw_feedbacks = await update_aw_feedback(submitData, isgetfeedback);\n\n        aw_feedbacks = JSON.parse(aw_feedbacks);\n\n        // Convert aw_feedbacks to string before parsing\n        var feedbackString = String(aw_feedbacks);\n        aw_feedbacks = JSON.parse(feedbackString);\n\n        feedbackString = Object.entries(aw_feedbacks[\"counts\"])\n            .map(([key, value]) => `${key}: ${value}`)\n            .join(\", \");\n\n        submitData.answer = feedbackString;\n\n        // Call the submit_feedback method from feedbackcollection module\n        feedbackcollection.submit_feedback(questionName, submitData, true);\n        var feedbackcommentdata  = {\n            question: \"Accessibility widget feedbacks\",\n            answer: JSON.stringify(aw_feedbacks[\"accessibilityfeedbacks\"]),\n        };\n\n        feedbackcollection.submit_feedback(\"accessibilitywidgetfeedback\", feedbackcommentdata, true);\n        UserRepository.setUserPreference('acs-feedback-status', true);\n        if (isgetfeedback) {\n            removeFeedbackOption();\n        }\n    }\n\n\n\n    // Check for notification after reload\n    $(document).ready(function () {\n        let notificationMessage = localStorage.getItem(\"awNotification\");\n        if (notificationMessage) {\n            Toast.add(notificationMessage, {\n                delay: 5000,\n                closeButton: true,\n                type: 'warning edw_aw_toast'\n            });\n            localStorage.removeItem(\"awNotification\"); // Clear the flag\n        }\n    });\n    return {\n        init: function (issiteadmin = false, feedbackstatus = false, isloggedin = false) {\n            registerCommonEvents(issiteadmin, feedbackstatus, isloggedin);\n        },\n    };\n});\n"],"names":["define","$","Ajax","Str","Toast","feedbackcollection","UserRepository","SELECTOR","registerCommonEvents","issiteadmin","feedbackstatus","isloggedin","document","on","e","preventDefault","$this","this","message","attr","updateAWState","href","string","value","M","util","get_string","localStorage","setItem","setTimeout","window","location","reload","siteadminurl","cfg","wwwroot","prefurl","show","hide","removeClass","async","removeFeedbackOption","question","val","questionName","submitData","answer","usercomment","feedbackHandler","formData","FormData","get","target","find","data","update_aw_feedback","submiteddata","isgetfeedback","call","methodname","args","action","config","JSON","stringify","$element","state","text","require","setUserPreference","onlyHide","css","addClass","feedback_option","remove","aw_feedbacks","parse","feedbackString","String","Object","entries","map","_ref","key","join","submit_feedback","feedbackcommentdata","ready","notificationMessage","getItem","add","delay","closeButton","type","removeItem","init"],"mappings":"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"}