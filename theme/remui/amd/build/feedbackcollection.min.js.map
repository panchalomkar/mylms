{"version":3,"file":"feedbackcollection.min.js","sources":["../src/feedbackcollection.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable jsdoc/require-jsdoc*/\n/* eslint-disable no-loop-func*/\n/* eslint-disable no-unused-vars */\n\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module feedbackcollection\n *\n * @module     theme_remui/feedbackcollection\n * @copyright  2024 YOUR NAME <your@email.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/templates'], function($, Ajax, Notification, Templates) {\n\n    let SELECTORS = {\n        'FEEDBACKCOLLECTION': 'body',\n        'FEEDBACKCOLLECTION_MODAL': '.feedbackcollection-modal',\n        'FEEDBACKCOLLECTION_FORM': '#feedbackcollection-form',\n    };\n\n    let custompagepublished = false;\n\n    // Check if either the last or current format is \"remuiformat\"\n    let edwisercourseformat = \"remuiformat\"; // The specific course format to check\n    let isRemuiformat = (format) => format === edwisercourseformat;\n    function submit_feedback(questionname, submiteddata, verifyuser = false) {\n        return Ajax.call([{\n            methodname: 'theme_remui_do_feedbackcollection_action',\n            args: {\n                action: \"submit_feedback\",\n                config: JSON.stringify({\n                    \"question\": questionname,\n                    \"feedback\": submiteddata,\n                    \"verifyuser\": verifyuser\n                })\n            }\n        }])[0];\n    }\n\n    function get_feedback_context(questionname) {\n        return Ajax.call([{\n            methodname: 'theme_remui_do_feedbackcollection_action',\n            args: {\n                action: \"get_feedback_context\",\n                config: JSON.stringify({\n                    questionname\n                })\n            }\n        }])[0];\n    }\n\n    function show_feedbackform_modal() {\n        $(SELECTORS.FEEDBACKCOLLECTION_MODAL).modal('show');\n    }\n\n    function close_modal() {\n        $(SELECTORS.FEEDBACKCOLLECTION_MODAL).modal('hide');\n\n        let feedbackTime = Date.now() + (24 * 60 * 60 * 1000); // Add 24 hours to current time\n        if($(\"body\").attr(\"id\") == \"page-site-index\") {\n            localStorage.setItem('frontpage_feedback_timestamp', feedbackTime);\n        }\n        if($('body').attr('id') == \"page-admin-setting-themesettingremui\") {\n            localStorage.setItem(\"remui_settings_feedback_visited\", \"false\");\n        }\n        if ($('body').hasClass(\"pagelayout-course\")) {\n            localStorage.setItem('courseformatchangetimestamps', feedbackTime);\n        }\n    }\n\n    async function render_feedbackform(questionname,callback = false) {\n        let templatename = \"theme_remui/feedbackcollection_form\";\n\n        const response = await get_feedback_context(questionname);\n        const data = JSON.parse(response);\n\n        if(data) {\n            data.questionname = questionname;\n            return Templates.render(templatename, {\n                config: M.cfg,\n                ...data\n            }).done(function(html, js) {\n                $(SELECTORS.FEEDBACKCOLLECTION_MODAL).remove();\n                Templates.appendNodeContents(\"body\", html, js);\n            }).then(() => {\n                show_feedbackform_modal();\n                if (typeof callback === \"function\") {\n                    callback();\n                }\n            });\n        }\n\n        return false;\n    }\n\n    async function submit_feedback_handler(e) {\n        e.preventDefault();\n\n        // Get form data\n        const formData = new FormData(e.target);\n        const submiteddata = { };\n        let questionname = \"\";\n\n        formData.forEach((value, key) => {\n            if (key === \"questionname\") {\n                questionname = value;\n            } else {\n                submiteddata[key] = value;\n            }\n        });\n\n        submit_feedback(questionname, submiteddata);\n\n        close_modal();\n    }\n\n    function courseformatfeedbackhandler() {\n\n\n        if($('body').attr('id') == \"page-course-edit\") {\n            // Get the last stored course format from localStorage\n            let lastactivecourseformat = localStorage.getItem('lastactivecourseformat');\n            let currentactivecourseformat = localStorage.getItem('currentactivecourseformat');\n            let currentselectedcourseformat = $(\"#fitem_id_format select#id_format option:selected\").val();\n\n            if(currentactivecourseformat) {\n                localStorage.setItem('lastactivecourseformat', currentactivecourseformat);\n                lastactivecourseformat = currentactivecourseformat;\n            }\n\n            if (!lastactivecourseformat) {\n                localStorage.setItem('lastactivecourseformat', currentselectedcourseformat);\n            } else {\n                localStorage.setItem('currentactivecourseformat', currentselectedcourseformat);\n            }\n            localStorage.setItem('courseformatchangetimestamps', Date.now());\n\n        }\n    }\n    function remui_settings_feedback_handler(){\n        if($('body').attr('id') != \"page-admin-setting-themesettingremui\") {\n            return;\n        }\n        let remuisettingvisited = localStorage.getItem(\"remui_settings_feedback_visited\");\n\n        if(remuisettingvisited == \"true\") {\n            render_feedbackform(\"remuisettingvisit_question\");\n        }\n    }\n\n    function homepagefeedbackhandler() {\n        let frontpageFeedbackTimestamp = localStorage.getItem('frontpage_feedback_timestamp');\n        let currentTime = Date.now();\n\n        if($(\"body\").attr(\"id\") != \"page-site-index\") {\n            return;\n        }\n\n        if(frontpageFeedbackTimestamp && currentTime >= parseInt(frontpageFeedbackTimestamp)) {\n\n            setTimeout(() => {\n                render_feedbackform(\"homepage_question\");\n\n            }, 2000);\n        }\n    }\n\n    return {\n        init: function(questionname = false) {\n\n            if(questionname) {\n                render_feedbackform(questionname);\n            }\n\n            $(document).on(\"click\", SELECTORS.FEEDBACKCOLLECTION + \" .skip-btn\", close_modal);\n\n            $(document).on(\"submit\", SELECTORS.FEEDBACKCOLLECTION_FORM, submit_feedback_handler);\n            $(document).on(\"submit\", \"#page-admin-setting-themesettingremui #adminsettings\", function(e) {\n                localStorage.setItem(\"remui_settings_feedback_visited\", \"true\");\n            });\n\n            $(document).on(\"click\", \"#page-site-index .advanceblockblocks .blockurl\", function(e) {\n                let feedbackTime = Date.now(); // Add 24 hours to current time\n                localStorage.setItem('frontpage_feedback_timestamp', feedbackTime);\n            });\n\n            $(document).on('click', '.page_sub_header .btn-publish', function() {custompagepublished = true;});\n            $(document).on('click', '#page-epb-page-draft .btn[data-action=\"save\"]', function () {\n                if (custompagepublished) {\n                    render_feedbackform(\"custompage_question\");\n                } else {\n                    custompagepublished = false;\n                }\n            });\n\n            let coursefeedbackrenderedcount = 0;\n            $(document).on(\"scroll\", function() {\n                if(coursefeedbackrenderedcount == 0) {\n                    if ($('body').hasClass(\"pagelayout-course\")) {\n                        // Calculate scroll position and page height\n                        let scrollPosition = window.scrollY;\n                        let windowHeight = window.innerHeight;\n                        let documentHeight = $(document).height();\n                        let scrollTriggerPoint = (documentHeight - windowHeight) * 0.4; // Trigger at 40% scroll\n                        // Check if user has scrolled past the trigger point\n                        if (scrollPosition > scrollTriggerPoint) {\n                            // If either format is \"remuiformat\", perform the action\n\n                            if(Date.now() >= parseInt(localStorage.getItem('courseformatchangetimestamps'))) {\n                                if (isRemuiformat(localStorage.getItem('lastactivecourseformat')) || isRemuiformat(localStorage.getItem('currentactivecourseformat'))) {\n                                    render_feedbackform(\"remuiformat_question\");\n                                    coursefeedbackrenderedcount++;\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n            // $(document).on('click', '#page-site-index a[href]', function(event) {\n            //     event.preventDefault(); // Stop the default redirect action\n\n            //     const targetUrl = $(this).attr('href'); // Get the link URL\n\n            //     if (targetUrl === '#' || $(this).closest('#add-block-float-menu').length || $(this).hasClass('block-add')) {\n            //         // Skip this link by simply returning from the function\n            //         return;\n            //     }\n\n            //     // Perform your custom action here\n            //     render_feedbackform(\"homepage_question\",function(){\n            //         $(document).on(\"click\", SELECTORS.FEEDBACKCOLLECTION + \" .skip-btn\", function(){\n            //             window.location.href = targetUrl;\n            //         });\n\n            //         $(document).on(\"submit\", SELECTORS.FEEDBACKCOLLECTION_FORM, function(){\n            //             window.location.href = targetUrl;\n            //         });\n            //     });\n            // });\n\n            homepagefeedbackhandler();\n            courseformatfeedbackhandler();\n            remui_settings_feedback_handler();\n        },\n        render_feedbackform,\n        submit_feedback_handler,\n        close_modal,\n        get_feedback_context,\n        submit_feedback\n    };\n});\n"],"names":["define","$","Ajax","Notification","Templates","SELECTORS","custompagepublished","isRemuiformat","format","submit_feedback","questionname","submiteddata","verifyuser","call","methodname","args","action","config","JSON","stringify","get_feedback_context","show_feedbackform_modal","modal","close_modal","feedbackTime","Date","now","attr","localStorage","setItem","hasClass","render_feedbackform","callback","templatename","response","data","parse","render","M","cfg","done","html","js","remove","appendNodeContents","then","submit_feedback_handler","e","preventDefault","formData","FormData","target","forEach","value","key","courseformatfeedbackhandler","lastactivecourseformat","getItem","currentactivecourseformat","currentselectedcourseformat","val","remui_settings_feedback_handler","homepagefeedbackhandler","frontpageFeedbackTimestamp","currentTime","parseInt","setTimeout","init","document","on","coursefeedbackrenderedcount","scrollPosition","window","scrollY","windowHeight","innerHeight","height"],"mappings":"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"}