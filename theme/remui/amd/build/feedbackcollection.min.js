/**
 * TODO describe module feedbackcollection
 *
 * @module     theme_remui/feedbackcollection
 * @copyright  2024 YOUR NAME <your@email.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("theme_remui/feedbackcollection",["jquery","core/ajax","core/notification","core/templates"],(function($,Ajax,Notification,Templates){let SELECTORS_FEEDBACKCOLLECTION="body",SELECTORS_FEEDBACKCOLLECTION_MODAL=".feedbackcollection-modal",SELECTORS_FEEDBACKCOLLECTION_FORM="#feedbackcollection-form",custompagepublished=!1,isRemuiformat=format=>"remuiformat"===format;function submit_feedback(questionname,submiteddata){let verifyuser=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return Ajax.call([{methodname:"theme_remui_do_feedbackcollection_action",args:{action:"submit_feedback",config:JSON.stringify({question:questionname,feedback:submiteddata,verifyuser:verifyuser})}}])[0]}function get_feedback_context(questionname){return Ajax.call([{methodname:"theme_remui_do_feedbackcollection_action",args:{action:"get_feedback_context",config:JSON.stringify({questionname:questionname})}}])[0]}function show_feedbackform_modal(){$(SELECTORS_FEEDBACKCOLLECTION_MODAL).modal("show")}function close_modal(){$(SELECTORS_FEEDBACKCOLLECTION_MODAL).modal("hide");let feedbackTime=Date.now()+864e5;"page-site-index"==$("body").attr("id")&&localStorage.setItem("frontpage_feedback_timestamp",feedbackTime),"page-admin-setting-themesettingremui"==$("body").attr("id")&&localStorage.setItem("remui_settings_feedback_visited","false"),$("body").hasClass("pagelayout-course")&&localStorage.setItem("courseformatchangetimestamps",feedbackTime)}async function render_feedbackform(questionname){let callback=arguments.length>1&&void 0!==arguments[1]&&arguments[1],templatename="theme_remui/feedbackcollection_form";const response=await get_feedback_context(questionname),data=JSON.parse(response);return!!data&&(data.questionname=questionname,Templates.render(templatename,{config:M.cfg,...data}).done((function(html,js){$(SELECTORS_FEEDBACKCOLLECTION_MODAL).remove(),Templates.appendNodeContents("body",html,js)})).then((()=>{show_feedbackform_modal(),"function"==typeof callback&&callback()})))}async function submit_feedback_handler(e){e.preventDefault();const formData=new FormData(e.target),submiteddata={};let questionname="";formData.forEach(((value,key)=>{"questionname"===key?questionname=value:submiteddata[key]=value})),submit_feedback(questionname,submiteddata),close_modal()}function courseformatfeedbackhandler(){if("page-course-edit"==$("body").attr("id")){let lastactivecourseformat=localStorage.getItem("lastactivecourseformat"),currentactivecourseformat=localStorage.getItem("currentactivecourseformat"),currentselectedcourseformat=$("#fitem_id_format select#id_format option:selected").val();currentactivecourseformat&&(localStorage.setItem("lastactivecourseformat",currentactivecourseformat),lastactivecourseformat=currentactivecourseformat),lastactivecourseformat?localStorage.setItem("currentactivecourseformat",currentselectedcourseformat):localStorage.setItem("lastactivecourseformat",currentselectedcourseformat),localStorage.setItem("courseformatchangetimestamps",Date.now())}}function remui_settings_feedback_handler(){if("page-admin-setting-themesettingremui"!=$("body").attr("id"))return;"true"==localStorage.getItem("remui_settings_feedback_visited")&&render_feedbackform("remuisettingvisit_question")}function homepagefeedbackhandler(){let frontpageFeedbackTimestamp=localStorage.getItem("frontpage_feedback_timestamp"),currentTime=Date.now();"page-site-index"==$("body").attr("id")&&frontpageFeedbackTimestamp&&currentTime>=parseInt(frontpageFeedbackTimestamp)&&setTimeout((()=>{render_feedbackform("homepage_question")}),2e3)}return{init:function(){let questionname=arguments.length>0&&void 0!==arguments[0]&&arguments[0];questionname&&render_feedbackform(questionname),$(document).on("click",SELECTORS_FEEDBACKCOLLECTION+" .skip-btn",close_modal),$(document).on("submit",SELECTORS_FEEDBACKCOLLECTION_FORM,submit_feedback_handler),$(document).on("submit","#page-admin-setting-themesettingremui #adminsettings",(function(e){localStorage.setItem("remui_settings_feedback_visited","true")})),$(document).on("click","#page-site-index .advanceblockblocks .blockurl",(function(e){let feedbackTime=Date.now();localStorage.setItem("frontpage_feedback_timestamp",feedbackTime)})),$(document).on("click",".page_sub_header .btn-publish",(function(){custompagepublished=!0})),$(document).on("click",'#page-epb-page-draft .btn[data-action="save"]',(function(){custompagepublished?render_feedbackform("custompage_question"):custompagepublished=!1}));let coursefeedbackrenderedcount=0;$(document).on("scroll",(function(){if(0==coursefeedbackrenderedcount&&$("body").hasClass("pagelayout-course")){let scrollPosition=window.scrollY,windowHeight=window.innerHeight;scrollPosition>.4*($(document).height()-windowHeight)&&Date.now()>=parseInt(localStorage.getItem("courseformatchangetimestamps"))&&(isRemuiformat(localStorage.getItem("lastactivecourseformat"))||isRemuiformat(localStorage.getItem("currentactivecourseformat")))&&(render_feedbackform("remuiformat_question"),coursefeedbackrenderedcount++)}})),homepagefeedbackhandler(),courseformatfeedbackhandler(),remui_settings_feedback_handler()},render_feedbackform:render_feedbackform,submit_feedback_handler:submit_feedback_handler,close_modal:close_modal,get_feedback_context:get_feedback_context,submit_feedback:submit_feedback}}));

//# sourceMappingURL=feedbackcollection.min.js.map