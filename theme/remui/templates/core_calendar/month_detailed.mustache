<div class="calendarwrapper rightb-card"
     {{#courseid}} data-courseid="{{courseid}}"{{/courseid}}
     {{#categoryid}} data-categoryid="{{categoryid}}"{{/categoryid}}
     data-context-id="{{defaulteventcontext}}"
     data-month="{{date.mon}}"
     data-year="{{date.year}}"
     data-view="{{view}}">

  <div class="myprofile-header d-flex justify-content-between align-items-center">
    <h5 class="myprofile-title">
      <i class="bi bi-calendar-week mr-2"></i> My Calendar
    </h5>
    <!-- 👁 Eye icon redirects to full calendar -->
    <a href="{{url}}" id="open-full-calendar" class="edit-profile-link"> 
      <i class="fa fa-eye"></i>
    </a>
  </div>

  {{!--> core_calendar/month_navigation --}}
  {{> core/overlay_loading}}

  <!-- Horizontal scroll wrapper -->
  <div class="calendar-horizontal-scroll-wrapper d-flex flex-nowrap">
      {{#weeks}}
          {{#days}}
              <div class="day-cell text-center
                  {{#istoday}} today{{/istoday}}
                  {{#isweekend}} weekend{{/isweekend}}
                  {{#hasevents}} hasevent{{/hasevents}}"
                  data-day="{{mday}}"
                  data-timestamp="{{timestamp}}"
                  data-region="day"
                  data-new-event-timestamp="{{neweventtimestamp}}">
                  
                  <div class="weekday"></div>
                  <div class="day-number-wrapper">{{mday}}</div>

                  {{#hasevents}}
                  <ul class="events-list d-none">
                      {{#events}}
<li data-region="event-item" 
    data-event-timestamp="{{timestart}}" 
    data-event-end="{{timeend}}">
    <a data-action="view-event" data-event-id="{{id}}" href="{{url}}" title="{{name}}">
        <span class="calendar-circle calendar_event_{{normalisedeventtype}}"></span>
        <span class="eventname">{{{name}}}</span>
    </a>
</li>


                      {{/events}}
                  </ul>
                  {{/hasevents}}
              </div>
          {{/days}}
      {{/weeks}}
  </div>

  <div id="selected-day-events" class="mt-3"></div>
</div>

<style>
.myprofile-header {
  border-bottom: 1px solid #f0f0f0;
  padding-bottom: 8px;
}

.myprofile-title {
  font-size: 15px;
  font-weight: 400;
  color: #333;
  margin: 0;
}

.calendar-horizontal-scroll-wrapper {
  overflow-x: auto;
  white-space: nowrap;
  background: #ecf0f7;
  border-radius: 10px;
}

.day-cell {
  flex: 0 0 auto;
  width: fit-content;
  margin-right: 3px;
  border: none;
  border-radius: 10px;
  padding: 0.3rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.hasevent.day-celll {
  border: solid 1px #ec9707;
}

.day-cell.today {
  border-color: #003152;
  background-color: #003152;
  color: #fff;
}

.day-cell.selected {
  border-color: #003152;
  background-color: #003152;
  color: #fff;
}

.weekday {
  font-weight: bold;
  margin-bottom: 0px;
  font-size: 8px;
}

.day-number-wrapper {
  background-color: transparent;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  margin: 0 auto 0.3rem;
  font-weight: bold;
}

.events-list {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 0.75rem;
}

.events-list li {
  margin-bottom: 0.2rem;
}
.eventname{  display: -webkit-box;        /* Required for ellipsis */
    -webkit-line-clamp: 1;       /* Limit to 1 line */
    -webkit-box-orient: vertical; 
    overflow: hidden;            /* Hide overflow text */
    text-overflow: ellipsis;     /* Show ... */
    white-space: normal;          /* Allow wrapping for webkit-box */}
</style>

{{#js}}
require(['jquery', 'core_calendar/month_view_drag_drop'], function($, DragDrop) {

    var root = $('.calendar-horizontal-scroll-wrapper');
    DragDrop.init(root);

    var weekdayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    root.find('.day-cell').each(function(){
        var ts = $(this).data('timestamp')*1000;
        var weekday = weekdayNames[new Date(ts).getDay()];
        $(this).find('.weekday').text(weekday);
    });

    // Scroll so that today is visible
    var todayCell = root.find('.day-cell.today');
    if(todayCell.length) {
        var wrapper = root[0];
        var offset = todayCell[0].offsetLeft - wrapper.offsetWidth / 4; 
        wrapper.scrollLeft = offset > 0 ? offset : 0;
    }

    // Show events for a day
    function showDayEvents(dayCell) {
        root.find('.day-cell').removeClass('selected');
        dayCell.addClass('selected');

        var ts = dayCell.data('timestamp')*1000;
        var dateObj = new Date(ts);
        var day = dateObj.getDate();
        var monthName = dateObj.toLocaleString('default', { month: 'long' });
        var year = dateObj.getFullYear();

        var events = [];
        dayCell.find('[data-region="event-item"]').each(function(index){
            var name = $(this).find('.eventname').text().trim();
            var url = $(this).find('a[data-action="view-event"]').attr('href');

            var eventStartTs = $(this).data('event-timestamp');
            var eventEndTs = $(this).data('event-end');

            if(!eventStartTs) return;

            var startDate = new Date(eventStartTs*1000);
            var startTimeStr = startDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            var endTimeStr = '';
            if(eventEndTs) {
                var endDate = new Date(eventEndTs*1000);
                endTimeStr = endDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            var timeStr = endTimeStr ? startTimeStr + ' - ' + endTimeStr : startTimeStr;

            var colors = ['#ffc107','#e83e8c','#0dcaf0','#198754','#6f42c1'];
            var color = colors[index % colors.length];

            // ✅ Generate calendar day URL for this event
            var dayUrl = M.cfg.wwwroot + '/calendar/view.php?view=day&time=' + Math.floor(eventStartTs);

            events.push({name, url, time: timeStr, color, dayUrl});
        });

        var container = $('#selected-day-events');
        container.empty();

        var header = `
            <div class="text-center gap-2 d-flex mb-2">
                <div class="month-name" style="font-size:11px;color:#003152;text-transform: uppercase;">${monthName}</div>
                <div class="date-number" style="font-size:11px;">${day}</div>
            </div>
        `;

        if(events.length === 0){
            container.html(header + '<div class="alert py-1 mb-0">No events on this date.</div>');
        } else {
            var list = $('<div class="list-group event-list-wrapper"></div>');
            events.forEach(function(ev){
                var item = `
                    <a href="javascript:void(0);" 
                       class="event-item d-flex align-items-center justify-content-between py-1 px-2 mb-1 rounded text-decoration-none" 
                       style="background:#fff;cursor:pointer;border-bottom: 1px solid #d4d4d4;border-radius: unset;" 
                       data-dayurl="${ev.dayUrl}">
                        <div class="d-flex align-items-center flex-grow-1">
                            <span class="eventtime text-muted me-2" style=" min-width: 48px;font-size:10px;text-align:left;">${ev.time}</span>
                            <span class="dot me-2" style="width:8px;height:8px;border-radius:50%;background:${ev.color};display:inline-block;"></span>
                            <span class="eventname" style="font-size:11px;font-weight:500;color:#333;">${ev.name}</span>
                        </div>
                    </a>
                `;
                list.append(item);
            });
            container.html(header).append(list);
        }
    }

    // Click on day
    root.on('click', '.day-cell', function(e){
        e.preventDefault();
        e.stopPropagation();
        showDayEvents($(this));
    });

    // Redirect to full month view
    $('#open-full-calendar').on('click', function(e){
        e.preventDefault();
        window.location.href = M.cfg.wwwroot + '/calendar/view.php?view=month';
    });

    // ✅ Click on any event to go to day view
    $(document).on('click', '.event-item', function(){
        var dayurl = $(this).data('dayurl');
        if(dayurl) {
            window.location.href = dayurl;
        }
    });

    // Auto-show today
    if(todayCell.length) {
        showDayEvents(todayCell);
    }

});

{{/js}}
